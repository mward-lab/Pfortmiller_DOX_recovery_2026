---
title: "5FU Recovery RNAseq Analysis"
author: "Emma M Pfortmiller"
date: "2025-02-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r Libraries}
library(ggplot2)
library(reshape2)
library(hrbrthemes)
library(tibble)
library(tidyverse)
library(edgebundleR)
library(readxl)
library(readr)
library(edgeR)
library(pheatmap)
library(ggfortify)
library(PCAtools)
library(Cormotif)
library(RColorBrewer)
library(biomaRt)
library(RUVSeq)
```



```{r Sheet with Mapped and Successfully Aligned Reads}
fC_AllCounts <- read_csv("C:/Users/emmap/RDirectory/Recovery_RNAseq/Recovery_RNAseq/Recovery_MappingStats_Subread_EMP_241104_250211.csv")
View(fC_AllCounts)
dim(fC_AllCounts)
#[1] 63  6
```

These samples (63 in total) have been aligned to the Ensembl 113 release of GRCh38 via subread, and counts have been generated using featureCounts with inbuilt hg38 genome

Data is located under 5FU Project on my computer
All analysis saved in RDirectory Recovery_RNAseq

Individual 1 - 84-1 (9 samples)
```{r Import Counts Data Individual 1 - 84-1, include=FALSE}
#abbreviated to the first two numbers of the cell line for ease
#9 samples per cell line
#problem sample 24!!

#84-1 DOX_24-> R27
  Counts_84_DOX_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R27_R1.counts.txt")  
  #View(Counts_84_DOX_24)



#84-1 FLUO_24 -> R28
  Counts_84_FLUO_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R28_R1.counts.txt")
  #View(Counts_84_FLUO_24)
  
#84-1 DMSO_24 -> R29
  Counts_84_DMSO_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R29_R1.counts.txt")
  #View(Counts_84_DMSO_24)
  
#84-1 DOX_24+24-> R30
  Counts_84_DOX_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R30_R1.counts.txt")
  #View(Counts_84_DOX_24rec)
  
#84-1 FLUO_24+24-> R31
  Counts_84_FLUO_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R31_R1.counts.txt")
  #View(Counts_84_FLUO_24rec)
  
#84-1 DMSO_24+24-> R32
  Counts_84_DMSO_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R32_R1.counts.txt")
  #View(Counts_84_DMSO_24rec)
  
#84-1 DOX_24+144 -> R33
  Counts_84_DOX_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R33_R1.counts.txt")
  #View(Counts_84_DOX_144rec)

#84-1 FLUO_24+144 -> R34
   Counts_84_FLUO_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R34_R1.counts.txt")
  #View(Counts_84_FLUO_144rec)
  
#84-1 DMSO_24+144 -> R35
   Counts_84_DMSO_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R35_R1.counts.txt")
  #View(Counts_84_DMSO_144rec)
  
```

Individual 2 - 87-1 (9 samples)
```{r Import Counts Individual 2 87-1, include=FALSE}
#abbreviated to the first two numbers of the cell line for ease
#9 samples per cell line

#87-1 DOX_24-> R36
  Counts_87_DOX_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R36_R1.counts.txt")  
  #View(Counts_87_DOX_24)

#87-1 FLUO_24 -> R37
  Counts_87_FLUO_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R37_R1.counts.txt")
  #View(Counts_87_FLUO_24)
  
#87-1 DMSO_24 -> R38
  Counts_87_DMSO_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R38_R1.counts.txt")
  #View(Counts_87_DMSO_24)
  
#87-1 DOX_24+24-> R39
  Counts_87_DOX_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R39_R1.counts.txt")
  #View(Counts_87_DOX_24rec)
  
#87-1 FLUO_24+24-> R40
  Counts_87_FLUO_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R40_R1.counts.txt")
  #View(Counts_87_FLUO_24rec)
  
#87-1 DMSO_24+24-> R41
  Counts_87_DMSO_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R41_R1.counts.txt")
  #View(Counts_87_DMSO_24rec)
  
#87-1 DOX_24+144 -> R42
  Counts_87_DOX_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R42_R1.counts.txt")
  #View(Counts_87_DOX_144rec)

#87-1 FLUO_24+144 -> R43
   Counts_87_FLUO_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R43_R1.counts.txt")
  #View(Counts_87_FLUO_144rec)
  
#87-1 DMSO_24+144 -> R44
   Counts_87_DMSO_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R44_R1.counts.txt")
  #View(Counts_87_DMSO_144rec)
  
```

Individual 3 - 75-1 (9 samples)
```{r Import Counts Individual 3 78-1, include=FALSE}
#abbreviated to the first two numbers of the cell line for ease
#9 samples per cell line

#78-1 DOX_24-> R45
  Counts_78_DOX_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R45_R1.counts.txt")  
  #View(Counts_78_DOX_24)

#78-1 FLUO_24 -> R46
  Counts_78_FLUO_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R46_R1.counts.txt")
  #View(Counts_78_FLUO_24)
  
#78-1 DMSO_24 -> R47
  Counts_78_DMSO_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R47_R1.counts.txt")
  #View(Counts_78_DMSO_24)
  
#78-1 DOX_24+24-> R48
  Counts_78_DOX_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R48_R1.counts.txt")
  #View(Counts_78_DOX_24rec)
  
#78-1 FLUO_24+24-> R49
  Counts_78_FLUO_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R49_R1.counts.txt")
  #View(Counts_78_FLUO_24rec)
  
#78-1 DMSO_24+24-> R50
  Counts_78_DMSO_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R50_R1.counts.txt")
  #View(Counts_78_DMSO_24rec)
  
#78-1 DOX_24+144 -> R51
  Counts_78_DOX_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R51_R1.counts.txt")
  #View(Counts_78_DOX_144rec)

#78-1 FLUO_24+144 -> R52
   Counts_78_FLUO_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R52_R1.counts.txt")
  #View(Counts_78_FLUO_144rec)
  
#78-1 DMSO_24+144 -> R53
   Counts_78_DMSO_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R53_R1.counts.txt")
  #View(Counts_78_DMSO_144rec)
   
```

Individual 4 - 75-1 (9 samples)
```{r Import Counts Individual 4 75-1, include=FALSE}
#abbreviated to the first two numbers of the cell line for ease
#9 samples per cell line

#75-1 DOX_24-> R54
  Counts_75_DOX_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R54_R1.counts.txt")  
  #View(Counts_75_DOX_24)

#75-1 FLUO_24 -> R55
  Counts_75_FLUO_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R55_R1.counts.txt")
  #View(Counts_75_FLUO_24)
  
#75-1 DMSO_24 -> R56
  Counts_75_DMSO_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R56_R1.counts.txt")
  #View(Counts_75_DMSO_24)
  
#75-1 DOX_24+24-> R57
  Counts_75_DOX_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R57_R1.counts.txt")
  #View(Counts_75_DOX_24rec)
  
#75-1 FLUO_24+24-> R58
  Counts_75_FLUO_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R58_R1.counts.txt")
  #View(Counts_75_FLUO_24rec)
  
#75-1 DMSO_24+24-> R59
  Counts_75_DMSO_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R59_R1.counts.txt")
  #View(Counts_75_DMSO_24rec)
  
#75-1 DOX_24+144 -> R60
  Counts_75_DOX_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R60_R1.counts.txt")
  #View(Counts_75_DOX_144rec)

#75-1 FLUO_24+144 -> R61
   Counts_75_FLUO_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R61_R1.counts.txt")
  #View(Counts_75_FLUO_144rec)
  
#75-1 DMSO_24+144 -> R62
   Counts_75_DMSO_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R62_R1.counts.txt")
  #View(Counts_75_DMSO_144rec)
   
```


Individual 5 - 17-3 (9 samples)
```{r Import Counts Individual 5 17-3, include=FALSE}
#abbreviated to the first two numbers of the cell line for ease
#9 samples per cell line

#17-3 DOX_24-> R63
  Counts_17_DOX_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R63_R1.counts.txt")  
  #View(Counts_17_DOX_24)

#17-3 FLUO_24 -> R64
  Counts_17_FLUO_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R64_R1.counts.txt")
  #View(Counts_17_FLUO_24)
  
#17-3 DMSO_24 -> R65
  Counts_17_DMSO_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R65_R1.counts.txt")
  #View(Counts_17_DMSO_24)
  
#17-3 DOX_24+24-> R66
  Counts_17_DOX_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R66_R1.counts.txt")
  #View(Counts_17_DOX_24rec)
  
#17-3 FLUO_24+24-> R67
  Counts_17_FLUO_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R67_R1.counts.txt")
  #View(Counts_17_FLUO_24rec)
  
#17-3 DMSO_24+24-> R68
  Counts_17_DMSO_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R68_R1.counts.txt")
  #View(Counts_17_DMSO_24rec)
  
#17-3 DOX_24+144 -> R69
  Counts_17_DOX_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R69_R1.counts.txt")
  #View(Counts_17_DOX_144rec)

#17-3 FLUO_24+144 -> R70
   Counts_17_FLUO_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R70_R1.counts.txt")
  #View(Counts_17_FLUO_144rec)
  
#17-3 DMSO_24+144 -> R71
   Counts_17_DMSO_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R71_R1.counts.txt")
  #View(Counts_17_DMSO_144rec)
   
```


Individual 6 - 90-1 (9 samples)
```{r Import Counts Individual 6 90-1, include=FALSE}
#abbreviated to the first two numbers of the cell line for ease
#9 samples per cell line

#90-1 DOX_24-> R72
  Counts_90_DOX_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R72_R1.counts.txt")  
  #View(Counts_90_DOX_24)

#90-1 FLUO_24 -> R73
  Counts_90_FLUO_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R73_R1.counts.txt")
  #View(Counts_90_FLUO_24)
  
#90-1 DMSO_24 -> R74
  Counts_90_DMSO_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R74_R1.counts.txt")
  #View(Counts_90_DMSO_24)
  
#90-1 DOX_24+24-> R75
  Counts_90_DOX_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R75_R1.counts.txt")
  #View(Counts_90_DOX_24rec)
  
#90-1 FLUO_24+24-> R76
  Counts_90_FLUO_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R76_R1.counts.txt")
  #View(Counts_90_FLUO_24rec)
  
#90-1 DMSO_24+24-> R77
  Counts_90_DMSO_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R77_R1.counts.txt")
  #View(Counts_90_DMSO_24rec)
  
#90-1 DOX_24+144 -> R78
  Counts_90_DOX_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R78_R1.counts.txt")
  #View(Counts_90_DOX_144rec)

#90-1 FLUO_24+144 -> R79
   Counts_90_FLUO_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R79_R1.counts.txt")
  #View(Counts_90_FLUO_144rec)
  
#90-1 DMSO_24+144 -> R80
   Counts_90_DMSO_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R80_R1.counts.txt")
  #View(Counts_90_DMSO_144rec)
   
```


Individual 7 - 90-1 REP (9 samples)
```{r Import Counts Individual 7 90-1 REP, include=FALSE}
#abbreviated to the first two numbers of the cell line for ease
#9 samples per cell line

#90-1 REP DOX_24-> R81
  Counts_90REP_DOX_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R81_R1.counts.txt")  
  #View(Counts_90_DOX_24)

#90-1 REP FLUO_24 -> R82
  Counts_90REP_FLUO_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R82_R1.counts.txt")
  #View(Counts_90_FLUO_24)
  
#90-1 REP DMSO_24 -> R83
  Counts_90REP_DMSO_24 <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R83_R1.counts.txt")
  #View(Counts_90_DMSO_24)
  
#90-1 REP DOX_24+24-> R84
  Counts_90REP_DOX_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R84_R1.counts.txt")
  #View(Counts_90_DOX_24rec)
  
#90-1 REP FLUO_24+24-> R85
  Counts_90REP_FLUO_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R85_R1.counts.txt")
  #View(Counts_90_FLUO_24rec)
  
#90-1 REP DMSO_24+24-> R86
  Counts_90REP_DMSO_24rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R86_R1.counts.txt")
  #View(Counts_90_DMSO_24rec)
  
#90-1 REP DOX_24+144 -> R87
  Counts_90REP_DOX_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R87_R1.counts.txt")
  #View(Counts_90_DOX_144rec)

#90-1 REP FLUO_24+144 -> R88
   Counts_90REP_FLUO_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R88_R1.counts.txt")
  #View(Counts_90_FLUO_144rec)
  
#90-1 REP DMSO_24+144 -> R89
   Counts_90REP_DMSO_144rec <- read.delim("C:/Users/emmap/OneDrive/Desktop/Ward Lab/Experiments/5FU Project/RNAseq/new counts/MCW_EMP_JT_R89_R1.counts.txt")
  #View(Counts_90_DMSO_144rec)
   
```
Now that I have imported all of these counts files, I will make a matrix with all of the samples

First I'll break them up by individual, and then combine them all together
```{r Counts Matrix 84-1, include=FALSE}

fC_Matrix_84_All <-
  data.frame(
    Counts_84_DOX_24,
    Counts_84_FLUO_24$MCW_EMP_JT_R28_R1.bam,
    Counts_84_DMSO_24$MCW_EMP_JT_R29_R1.bam,
    Counts_84_DOX_24rec$MCW_EMP_JT_R30_R1.bam,
    Counts_84_FLUO_24rec$MCW_EMP_JT_R31_R1.bam,
    Counts_84_DMSO_24rec$MCW_EMP_JT_R32_R1.bam,
    Counts_84_DOX_144rec$MCW_EMP_JT_R33_R1.bam,
    Counts_84_FLUO_144rec$MCW_EMP_JT_R34_R1.bam,
    Counts_84_DMSO_144rec$MCW_EMP_JT_R35_R1.bam
  )
colnames(fC_Matrix_84_All) <- c("ensembl_gene_id", 
                                "DOX_24_Ind1",
                                "FLUO_24_Ind1",
                                "DMSO_24_Ind1",
                                "DOX_24rec_Ind1",
                                "FLUO_24rec_Ind1",
                                "DMSO_24rec_Ind1",
                                "DOX_144rec_Ind1",
                                "FLUO_144rec_Ind1",
                                "DMSO_144rec_Ind1")

fC_Matrix_84 <- fC_Matrix_84_All %>% remove_rownames %>% column_to_rownames(var = "ensembl_gene_id") %>% as.matrix()

#write this one to a csv so I can hold onto it
#write.csv(fC_Matrix_84_All, "C:/Users/emmap/RDirectory/Recovery_RNAseq/Recovery_RNAseq/featureCounts_Concat_Matrix_84-1_EMP_250210.csv")

boxplot(fC_Matrix_84,  xlab = "Conditions", ylab = "Unfiltered Counts", ylim= c(-10, 100), main = "Boxplot of Raw Counts 84-1")

hist(fC_Matrix_84,  xlab = "Unfiltered Counts", xlim = c(-1000,25000), ylim = c(-100, 20000), main = "Histogram of Raw Counts 84-1")


```

```{r Counts Matrix Individual 2 87-1, include=FALSE}

fC_Matrix_87_All <-
  data.frame(
    Counts_87_DOX_24,
    Counts_87_FLUO_24$MCW_EMP_JT_R37_R1.bam,
    Counts_87_DMSO_24$MCW_EMP_JT_R38_R1.bam,
    Counts_87_DOX_24rec$MCW_EMP_JT_R39_R1.bam,
    Counts_87_FLUO_24rec$MCW_EMP_JT_R40_R1.bam,
    Counts_87_DMSO_24rec$MCW_EMP_JT_R41_R1.bam,
    Counts_87_DOX_144rec$MCW_EMP_JT_R42_R1.bam,
    Counts_87_FLUO_144rec$MCW_EMP_JT_R43_R1.bam,
    Counts_87_DMSO_144rec$MCW_EMP_JT_R44_R1.bam
  )
colnames(fC_Matrix_87_All) <- c("ensembl_gene_id", 
                                "DOX_24_Ind2",
                                "FLUO_24_Ind2",
                                "DMSO_24_Ind2",
                                "DOX_24rec_Ind2",
                                "FLUO_24rec_Ind2",
                                "DMSO_24rec_Ind2",
                                "DOX_144rec_Ind2",
                                "FLUO_144rec_Ind2",
                                "DMSO_144rec_Ind2")

fC_Matrix_87 <- fC_Matrix_87_All %>% remove_rownames %>% column_to_rownames(var = "ensembl_gene_id") %>% as.matrix()

#write this one to a csv so I can hold onto it
# write.csv(fC_Matrix_87_All, "C:/Users/emmap/RDirectory/Recovery_RNAseq/Recovery_RNAseq/featureCounts_Concat_Matrix_87-1_EMP_250210.csv")

boxplot(fC_Matrix_87,  xlab = "Conditions", ylab = "Unfiltered Counts", ylim= c(-10, 100), main = "Boxplot of Raw Counts 87-1")

hist(fC_Matrix_87,  xlab = "Unfiltered Counts", xlim = c(-1000,25000), ylim = c(-100, 20000), main = "Histogram of Raw Counts 87-1")


```


```{r Counts Matrix Individual 3 78-1, include=FALSE}

fC_Matrix_78_All <-
  data.frame(
    Counts_78_DOX_24,
    Counts_78_FLUO_24$MCW_EMP_JT_R46_R1.bam,
    Counts_78_DMSO_24$MCW_EMP_JT_R47_R1.bam,
    Counts_78_DOX_24rec$MCW_EMP_JT_R48_R1.bam,
    Counts_78_FLUO_24rec$MCW_EMP_JT_R49_R1.bam,
    Counts_78_DMSO_24rec$MCW_EMP_JT_R50_R1.bam,
    Counts_78_DOX_144rec$MCW_EMP_JT_R51_R1.bam,
    Counts_78_FLUO_144rec$MCW_EMP_JT_R52_R1.bam,
    Counts_78_DMSO_144rec$MCW_EMP_JT_R53_R1.bam
  )
colnames(fC_Matrix_78_All) <- c("ensembl_gene_id", 
                                "DOX_24_Ind3",
                                "FLUO_24_Ind3",
                                "DMSO_24_Ind3",
                                "DOX_24rec_Ind3",
                                "FLUO_24rec_Ind3",
                                "DMSO_24rec_Ind3",
                                "DOX_144rec_Ind3",
                                "FLUO_144rec_Ind3",
                                "DMSO_144rec_Ind3")

fC_Matrix_78 <- fC_Matrix_78_All %>% remove_rownames %>% column_to_rownames(var = "ensembl_gene_id") %>% as.matrix()

#write this one to a csv so I can hold onto it
# write.csv(fC_Matrix_78_All, "C:/Users/emmap/RDirectory/Recovery_RNAseq/Recovery_RNAseq/featureCounts_Concat_Matrix_78-1_EMP_250210.csv")

boxplot(fC_Matrix_78,  xlab = "Conditions", ylab = "Unfiltered Counts", ylim= c(-10, 100), main = "Boxplot of Raw Counts 78-1")

hist(fC_Matrix_78,  xlab = "Unfiltered Counts", xlim = c(-1000,25000), ylim = c(-100, 20000), main = "Histogram of Raw Counts 78-1")


```


```{r Counts Matrix Individual 4 75-1, include=FALSE}

fC_Matrix_75_All <-
  data.frame(
    Counts_75_DOX_24,
    Counts_75_FLUO_24$MCW_EMP_JT_R55_R1.bam,
    Counts_75_DMSO_24$MCW_EMP_JT_R56_R1.bam,
    Counts_75_DOX_24rec$MCW_EMP_JT_R57_R1.bam,
    Counts_75_FLUO_24rec$MCW_EMP_JT_R58_R1.bam,
    Counts_75_DMSO_24rec$MCW_EMP_JT_R59_R1.bam,
    Counts_75_DOX_144rec$MCW_EMP_JT_R60_R1.bam,
    Counts_75_FLUO_144rec$MCW_EMP_JT_R61_R1.bam,
    Counts_75_DMSO_144rec$MCW_EMP_JT_R62_R1.bam
  )
colnames(fC_Matrix_75_All) <- c("ensembl_gene_id", 
                                "DOX_24_Ind4",
                                "FLUO_24_Ind4",
                                "DMSO_24_Ind4",
                                "DOX_24rec_Ind4",
                                "FLUO_24rec_Ind4",
                                "DMSO_24rec_Ind4",
                                "DOX_144rec_Ind4",
                                "FLUO_144rec_Ind4",
                                "DMSO_144rec_Ind4")

fC_Matrix_75 <- fC_Matrix_75_All %>% remove_rownames %>% column_to_rownames(var = "ensembl_gene_id") %>% as.matrix()

#write this one to a csv so I can hold onto it
# write.csv(fC_Matrix_75_All, "C:/Users/emmap/RDirectory/Recovery_RNAseq/Recovery_RNAseq/featureCounts_Concat_Matrix_75-1_EMP_250210.csv")

boxplot(fC_Matrix_75,  xlab = "Conditions", ylab = "Unfiltered Counts", ylim= c(-10, 100), main = "Boxplot of Raw Counts 75-1")

hist(fC_Matrix_75,  xlab = "Unfiltered Counts", xlim = c(-1000,25000), ylim = c(-100, 20000), main = "Histogram of Raw Counts 75-1")


```


```{r Counts Matrix Individual 5 17-3, include=FALSE}

fC_Matrix_17_All <-
  data.frame(
    Counts_17_DOX_24,
    Counts_17_FLUO_24$MCW_EMP_JT_R64_R1.bam,
    Counts_17_DMSO_24$MCW_EMP_JT_R65_R1.bam,
    Counts_17_DOX_24rec$MCW_EMP_JT_R66_R1.bam,
    Counts_17_FLUO_24rec$MCW_EMP_JT_R67_R1.bam,
    Counts_17_DMSO_24rec$MCW_EMP_JT_R68_R1.bam,
    Counts_17_DOX_144rec$MCW_EMP_JT_R69_R1.bam,
    Counts_17_FLUO_144rec$MCW_EMP_JT_R70_R1.bam,
    Counts_17_DMSO_144rec$MCW_EMP_JT_R71_R1.bam
  )
colnames(fC_Matrix_17_All) <- c("ensembl_gene_id", 
                                "DOX_24_Ind5",
                                "FLUO_24_Ind5",
                                "DMSO_24_Ind5",
                                "DOX_24rec_Ind5",
                                "FLUO_24rec_Ind5",
                                "DMSO_24rec_Ind5",
                                "DOX_144rec_Ind5",
                                "FLUO_144rec_Ind5",
                                "DMSO_144rec_Ind5")

fC_Matrix_17 <- fC_Matrix_17_All %>% remove_rownames %>% column_to_rownames(var = "ensembl_gene_id") %>% as.matrix()

#write this one to a csv so I can hold onto it
# write.csv(fC_Matrix_17_All, "C:/Users/emmap/RDirectory/Recovery_RNAseq/Recovery_RNAseq/featureCounts_Concat_Matrix_17-1_EMP_250210.csv")

boxplot(fC_Matrix_17,  xlab = "Conditions", ylab = "Unfiltered Counts", ylim= c(-10, 100), main = "Boxplot of Raw Counts 17-3")

hist(fC_Matrix_17,  xlab = "Unfiltered Counts", xlim = c(-1000,25000), ylim = c(-100, 20000), main = "Histogram of Raw Counts 17-3")


```


```{r Counts Matrix Individual 6 90-1, include=FALSE}

fC_Matrix_90_All <-
  data.frame(
    Counts_90_DOX_24,
    Counts_90_FLUO_24$MCW_EMP_JT_R73_R1.bam,
    Counts_90_DMSO_24$MCW_EMP_JT_R74_R1.bam,
    Counts_90_DOX_24rec$MCW_EMP_JT_R75_R1.bam,
    Counts_90_FLUO_24rec$MCW_EMP_JT_R76_R1.bam,
    Counts_90_DMSO_24rec$MCW_EMP_JT_R77_R1.bam,
    Counts_90_DOX_144rec$MCW_EMP_JT_R78_R1.bam,
    Counts_90_FLUO_144rec$MCW_EMP_JT_R79_R1.bam,
    Counts_90_DMSO_144rec$MCW_EMP_JT_R80_R1.bam
  )
colnames(fC_Matrix_90_All) <- c("ensembl_gene_id", 
                                "DOX_24_Ind6",
                                "FLUO_24_Ind6",
                                "DMSO_24_Ind6",
                                "DOX_24rec_Ind6",
                                "FLUO_24rec_Ind6",
                                "DMSO_24rec_Ind6",
                                "DOX_144rec_Ind6",
                                "FLUO_144rec_Ind6",
                                "DMSO_144rec_Ind6")

fC_Matrix_90 <- fC_Matrix_90_All %>% remove_rownames %>% column_to_rownames(var = "ensembl_gene_id") %>% as.matrix()

#write this one to a csv so I can hold onto it
# write.csv(fC_Matrix_90_All, "C:/Users/emmap/RDirectory/Recovery_RNAseq/Recovery_RNAseq/featureCounts_Concat_Matrix_90-1_EMP_250210.csv")

boxplot(fC_Matrix_90,  xlab = "Conditions", ylab = "Unfiltered Counts", ylim= c(-10, 100), main = "Boxplot of Raw Counts 90-1")

hist(fC_Matrix_90,  xlab = "Unfiltered Counts", xlim = c(-1000,25000), ylim = c(-100, 20000), main = "Histogram of Raw Counts 90-1")


```


```{r Counts Matrix Individual 6 90-1REP, include=FALSE}

fC_Matrix_90REP_All <-
  data.frame(
    Counts_90REP_DOX_24,
    Counts_90REP_FLUO_24$MCW_EMP_JT_R82_R1.bam,
    Counts_90REP_DMSO_24$MCW_EMP_JT_R83_R1.bam,
    Counts_90REP_DOX_24rec$MCW_EMP_JT_R84_R1.bam,
    Counts_90REP_FLUO_24rec$MCW_EMP_JT_R85_R1.bam,
    Counts_90REP_DMSO_24rec$MCW_EMP_JT_R86_R1.bam,
    Counts_90REP_DOX_144rec$MCW_EMP_JT_R87_R1.bam,
    Counts_90REP_FLUO_144rec$MCW_EMP_JT_R88_R1.bam,
    Counts_90REP_DMSO_144rec$MCW_EMP_JT_R89_R1.bam
  )
colnames(fC_Matrix_90REP_All) <- c("ensembl_gene_id", 
                                "DOX_24_Ind6REP",
                                "FLUO_24_Ind6REP",
                                "DMSO_24_Ind6REP",
                                "DOX_24rec_Ind6REP",
                                "FLUO_24rec_Ind6REP",
                                "DMSO_24rec_Ind6REP",
                                "DOX_144rec_Ind6REP",
                                "FLUO_144rec_Ind6REP",
                                "DMSO_144rec_Ind6REP")

fC_Matrix_90REP <- fC_Matrix_90REP_All %>% remove_rownames %>% column_to_rownames(var = "ensembl_gene_id") %>% as.matrix()

#write this one to a csv so I can hold onto it
# write.csv(fC_Matrix_90REP_All, "C:/Users/emmap/RDirectory/Recovery_RNAseq/Recovery_RNAseq/featureCounts_Concat_Matrix_90-1REP_EMP_250210.csv")

boxplot(fC_Matrix_90REP,  xlab = "Conditions", ylab = "Unfiltered Counts", ylim= c(-10, 100), main = "Boxplot of Raw Counts 90-1 REP")

hist(fC_Matrix_90REP,  xlab = "Unfiltered Counts", xlim = c(-1000,25000), ylim = c(-100, 20000), main = "Histogram of Raw Counts 90-1 REP")


```


Now that I've made individual matrices for each individual - I will combine them together into one large matrix

```{r Counts Matrix All Individuals, include=FALSE}

fC_Matrix_AllInd <-
  data.frame(
    Counts_84_DOX_24,
    Counts_84_FLUO_24$MCW_EMP_JT_R28_R1.bam,
    Counts_84_DMSO_24$MCW_EMP_JT_R29_R1.bam,
    Counts_84_DOX_24rec$MCW_EMP_JT_R30_R1.bam,
    Counts_84_FLUO_24rec$MCW_EMP_JT_R31_R1.bam,
    Counts_84_DMSO_24rec$MCW_EMP_JT_R32_R1.bam,
    Counts_84_DOX_144rec$MCW_EMP_JT_R33_R1.bam,
    Counts_84_FLUO_144rec$MCW_EMP_JT_R34_R1.bam,
    Counts_84_DMSO_144rec$MCW_EMP_JT_R35_R1.bam,
    Counts_87_DOX_24$MCW_EMP_JT_R36_R1.bam,
    Counts_87_FLUO_24$MCW_EMP_JT_R37_R1.bam,
    Counts_87_DMSO_24$MCW_EMP_JT_R38_R1.bam,
    Counts_87_DOX_24rec$MCW_EMP_JT_R39_R1.bam,
    Counts_87_FLUO_24rec$MCW_EMP_JT_R40_R1.bam,
    Counts_87_DMSO_24rec$MCW_EMP_JT_R41_R1.bam,
    Counts_87_DOX_144rec$MCW_EMP_JT_R42_R1.bam,
    Counts_87_FLUO_144rec$MCW_EMP_JT_R43_R1.bam,
    Counts_87_DMSO_144rec$MCW_EMP_JT_R44_R1.bam,
    Counts_78_DOX_24$MCW_EMP_JT_R45_R1.bam,
    Counts_78_FLUO_24$MCW_EMP_JT_R46_R1.bam,
    Counts_78_DMSO_24$MCW_EMP_JT_R47_R1.bam,
    Counts_78_DOX_24rec$MCW_EMP_JT_R48_R1.bam,
    Counts_78_FLUO_24rec$MCW_EMP_JT_R49_R1.bam,
    Counts_78_DMSO_24rec$MCW_EMP_JT_R50_R1.bam,
    Counts_78_DOX_144rec$MCW_EMP_JT_R51_R1.bam,
    Counts_78_FLUO_144rec$MCW_EMP_JT_R52_R1.bam,
    Counts_78_DMSO_144rec$MCW_EMP_JT_R53_R1.bam,
    Counts_75_DOX_24$MCW_EMP_JT_R54_R1.bam,
    Counts_75_FLUO_24$MCW_EMP_JT_R55_R1.bam,
    Counts_75_DMSO_24$MCW_EMP_JT_R56_R1.bam,
    Counts_75_DOX_24rec$MCW_EMP_JT_R57_R1.bam,
    Counts_75_FLUO_24rec$MCW_EMP_JT_R58_R1.bam,
    Counts_75_DMSO_24rec$MCW_EMP_JT_R59_R1.bam,
    Counts_75_DOX_144rec$MCW_EMP_JT_R60_R1.bam,
    Counts_75_FLUO_144rec$MCW_EMP_JT_R61_R1.bam,
    Counts_75_DMSO_144rec$MCW_EMP_JT_R62_R1.bam,
    Counts_17_DOX_24$MCW_EMP_JT_R63_R1.bam,
    Counts_17_FLUO_24$MCW_EMP_JT_R64_R1.bam,
    Counts_17_DMSO_24$MCW_EMP_JT_R65_R1.bam,
    Counts_17_DOX_24rec$MCW_EMP_JT_R66_R1.bam,
    Counts_17_FLUO_24rec$MCW_EMP_JT_R67_R1.bam,
    Counts_17_DMSO_24rec$MCW_EMP_JT_R68_R1.bam,
    Counts_17_DOX_144rec$MCW_EMP_JT_R69_R1.bam,
    Counts_17_FLUO_144rec$MCW_EMP_JT_R70_R1.bam,
    Counts_17_DMSO_144rec$MCW_EMP_JT_R71_R1.bam,
    Counts_90_DOX_24$MCW_EMP_JT_R72_R1.bam,
    Counts_90_FLUO_24$MCW_EMP_JT_R73_R1.bam,
    Counts_90_DMSO_24$MCW_EMP_JT_R74_R1.bam,
    Counts_90_DOX_24rec$MCW_EMP_JT_R75_R1.bam,
    Counts_90_FLUO_24rec$MCW_EMP_JT_R76_R1.bam,
    Counts_90_DMSO_24rec$MCW_EMP_JT_R77_R1.bam,
    Counts_90_DOX_144rec$MCW_EMP_JT_R78_R1.bam,
    Counts_90_FLUO_144rec$MCW_EMP_JT_R79_R1.bam,
    Counts_90_DMSO_144rec$MCW_EMP_JT_R80_R1.bam,
    Counts_90REP_DOX_24$MCW_EMP_JT_R81_R1.bam,
    Counts_90REP_FLUO_24$MCW_EMP_JT_R82_R1.bam,
    Counts_90REP_DMSO_24$MCW_EMP_JT_R83_R1.bam,
    Counts_90REP_DOX_24rec$MCW_EMP_JT_R84_R1.bam,
    Counts_90REP_FLUO_24rec$MCW_EMP_JT_R85_R1.bam,
    Counts_90REP_DMSO_24rec$MCW_EMP_JT_R86_R1.bam,
    Counts_90REP_DOX_144rec$MCW_EMP_JT_R87_R1.bam,
    Counts_90REP_FLUO_144rec$MCW_EMP_JT_R88_R1.bam,
    Counts_90REP_DMSO_144rec$MCW_EMP_JT_R89_R1.bam
  )

colnames(fC_Matrix_AllInd) <- c("ensembl_gene_id", 
                                "DOX_24_Ind1",
                                "FLUO_24_Ind1",
                                "DMSO_24_Ind1",
                                "DOX_24rec_Ind1",
                                "FLUO_24rec_Ind1",
                                "DMSO_24rec_Ind1",
                                "DOX_144rec_Ind1",
                                "FLUO_144rec_Ind1",
                                "DMSO_144rec_Ind1",
                                "DOX_24_Ind2",
                                "FLUO_24_Ind2",
                                "DMSO_24_Ind2",
                                "DOX_24rec_Ind2",
                                "FLUO_24rec_Ind2",
                                "DMSO_24rec_Ind2",
                                "DOX_144rec_Ind2",
                                "FLUO_144rec_Ind2",
                                "DMSO_144rec_Ind2",
                                "DOX_24_Ind3",
                                "FLUO_24_Ind3",
                                "DMSO_24_Ind3",
                                "DOX_24rec_Ind3",
                                "FLUO_24rec_Ind3",
                                "DMSO_24rec_Ind3",
                                "DOX_144rec_Ind3",
                                "FLUO_144rec_Ind3",
                                "DMSO_144rec_Ind3",
                                "DOX_24_Ind4",
                                "FLUO_24_Ind4",
                                "DMSO_24_Ind4",
                                "DOX_24rec_Ind4",
                                "FLUO_24rec_Ind4",
                                "DMSO_24rec_Ind4",
                                "DOX_144rec_Ind4",
                                "FLUO_144rec_Ind4",
                                "DMSO_144rec_Ind4",
                                "DOX_24_Ind5",
                                "FLUO_24_Ind5",
                                "DMSO_24_Ind5",
                                "DOX_24rec_Ind5",
                                "FLUO_24rec_Ind5",
                                "DMSO_24rec_Ind5",
                                "DOX_144rec_Ind5",
                                "FLUO_144rec_Ind5",
                                "DMSO_144rec_Ind5",
                                "DOX_24_Ind6",
                                "FLUO_24_Ind6",
                                "DMSO_24_Ind6",
                                "DOX_24rec_Ind6",
                                "FLUO_24rec_Ind6",
                                "DMSO_24rec_Ind6",
                                "DOX_144rec_Ind6",
                                "FLUO_144rec_Ind6",
                                "DMSO_144rec_Ind6",
                                "DOX_24_Ind6REP",
                                "FLUO_24_Ind6REP",
                                "DMSO_24_Ind6REP",
                                "DOX_24rec_Ind6REP",
                                "FLUO_24rec_Ind6REP",
                                "DMSO_24rec_Ind6REP",
                                "DOX_144rec_Ind6REP",
                                "FLUO_144rec_Ind6REP",
                                "DMSO_144rec_Ind6REP")

fC_Matrix_Full <- fC_Matrix_AllInd %>% remove_rownames %>% column_to_rownames(var = "ensembl_gene_id") %>% as.matrix()

#write this one to a csv so I can hold onto it
#write.csv(fC_Matrix_AllInd, "C:/Users/emmap/RDirectory/Recovery_RNAseq/Recovery_RNAseq/featureCounts_Concat_Matrix_AllSamples_EMP_250220.csv")

boxplot(fC_Matrix_Full,  xlab = "Conditions", ylab = "Unfiltered Counts", ylim= c(-10, 1000), main = "Boxplot of Raw Counts All Individuals")

hist(fC_Matrix_Full,  xlab = "Unfiltered Counts", xlim = c(-1000,125000), ylim = c(-100, 6000000), main = "Histogram of Raw Counts All Individuals")


```

```{r QC checks Raw Counts, fig.height=10, fig.width=12}
#Now that I've put together my matrix - I will do some QC checks

#Raw Counts
fC_Matrix_Full

Counts_Full_df <- data.frame(fC_Matrix_Full)

#define colors
ind_col <- c("#003F5C", "#45AE91",  "#58508D", "#BC4099", "#8B3E9B", "#FF6361", "#FF2362")

tx_col <- c("#63666D", "#DCACED", "#499FBD")

time_col <- c("#fbb4b9", "#f768a1", "#ae017e")


#factor my df to get all the factors
annotate_Counts <- data.frame("samples" = colnames(Counts_Full_df)) %>% separate_wider_delim(., cols = samples, names = c("Treatment", "Time", "Individual"), delim = "_", cols_remove = FALSE)
#%>% unite(., col = "Treatment_Time", "Treatment", "Time", sep = "_", remove = FALSE)

#now cbind these factors of my data to my raw counts file, transpose first

annotate_Counts_full <- (t(Counts_Full_df)) %>%  cbind(., annotate_Counts)
 
#now I'll factor by sample to keep order

#Counts_Full_df %>% dplyr::add_row()

annot_Counts_full_df <- as.data.frame(t(annotate_Counts_full))

#now that I have all of my factors and my gene info, I will make some graphs to show the QC data

reads_by_sample <- c(tx_col)
fC_AllCounts %>% 
  ggplot(., aes (x = Conditions, y = Total_Align, fill = Treatment, group_by = Line))+
  geom_col()+
 geom_hline(aes(yintercept=20000000))+
 scale_fill_manual(values=reads_by_sample)+
  ggtitle(expression("Total number of reads by sample"))+
  xlab("")+
  ylab(expression("RNA-sequencing reads"))+
  theme_bw()+
  theme(plot.title = element_text(size = rel(2), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text.y = element_text(size =10, color = "black", angle = 0, hjust = 0.8, vjust = 0.5),
        axis.text.x = element_text(size =10, color = "black", angle = 90, hjust = 1, vjust = 0.2),
        #strip.text.x = element_text(size = 15, color = "black", face = "bold"),
        strip.text.y = element_text(color = "white"))


####Read Counts by Treatment####
fC_AllCounts %>% 
  ggplot(., aes (x =Treatment, y= Total_Align, fill = Treatment))+
  geom_boxplot()+
 scale_fill_manual(values=reads_by_sample)+
  ggtitle(expression("Total number of reads by treatment"))+
  xlab("")+
  ylab(expression("RNA-sequencing reads"))+
  theme_bw()+
  
  theme(plot.title = element_text(size = rel(2), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text.y = element_text(size =10, color = "black", angle = 0, hjust = 0.8, vjust = 0.5),
        axis.text.x = element_text(size =10, color = "black", angle = 90, hjust = 1, vjust = 0.2),
        #strip.text.x = element_text(size = 15, color = "black", face = "bold"),
        strip.text.y = element_text(color = "white"))

####Total Reads Per Individual####
fC_AllCounts %>% 
  ggplot(., aes (x =as.factor(Line), y=Total_Align))+
  geom_boxplot(aes(fill=as.factor(Line)))+
 scale_fill_brewer(palette = "Dark2", name = "Individual")+
  ggtitle(expression("Total number of reads by individual"))+
  xlab("")+
  ylab(expression("RNA-sequencing reads"))+
  theme_bw()+

  theme(plot.title = element_text(size = rel(2), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text.y = element_text(size =10, color = "black", angle = 0, hjust = 0.8, vjust = 0.5),
        axis.text.x = element_text(size =10, color = "black", angle = 0, hjust = 1),
        #strip.text.x = element_text(size = 15, color = "black", face = "bold"),
        strip.text.y = element_text(color = "white"))

####Total Mapped Reads Per Drug####

reads_by_sample <- c(tx_col)
fC_AllCounts %>% 
  ggplot(., aes (x = Conditions, y = Assigned_Align, fill = Treatment, group_by = Line))+
  geom_col()+
 geom_hline(aes(yintercept=20000000))+
 scale_fill_manual(values=reads_by_sample)+
  ggtitle(expression("Total number of mapped reads by sample"))+
  xlab("")+
  ylab(expression("RNA-sequencing reads"))+
  theme_bw()+
  theme(plot.title = element_text(size = rel(2), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text.y = element_text(size =10, color = "black", angle = 0, hjust = 0.8, vjust = 0.5),
        axis.text.x = element_text(size =10, color = "black", angle = 90, hjust = 1, vjust = 0.2),
        #strip.text.x = element_text(size = 15, color = "black", face = "bold"),
        strip.text.y = element_text(color = "white"))


####Read Counts by Treatment####
fC_AllCounts %>% 
  ggplot(., aes (x =Treatment, y= Assigned_Align, fill = Treatment))+
  geom_boxplot()+
 scale_fill_manual(values=reads_by_sample)+
  ggtitle(expression("Total number of mapped reads by treatment"))+
  xlab("")+
  ylab(expression("RNA-sequencing reads"))+
  theme_bw()+
  
  theme(plot.title = element_text(size = rel(2), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text.y = element_text(size =10, color = "black", angle = 0, hjust = 0.8, vjust = 0.5),
        axis.text.x = element_text(size =10, color = "black", angle = 90, hjust = 1, vjust = 0.2),
        #strip.text.x = element_text(size = 15, color = "black", face = "bold"),
        strip.text.y = element_text(color = "white"))

####Total Reads Per Individual####
fC_AllCounts %>% 
  ggplot(., aes (x =as.factor(Line), y=Assigned_Align))+
  geom_boxplot(aes(fill=as.factor(Line)))+
 scale_fill_brewer(palette = "Dark2", name = "Individual")+
  ggtitle(expression("Total number of mapped reads by individual"))+
  xlab("")+
  ylab(expression("RNA-sequencing reads"))+
  theme_bw()+

  theme(plot.title = element_text(size = rel(2), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text.y = element_text(size =10, color = "black", angle = 0, hjust = 0.8, vjust = 0.5),
        axis.text.x = element_text(size =10, color = "black", angle = 0, hjust = 1),
        #strip.text.x = element_text(size = 15, color = "black", face = "bold"),
        strip.text.y = element_text(color = "white"))


```

Now that I've made the final full matrix of all samples -
1. convert to log2cpm
2. filter for lowly expressed reads (rowMeans > 0)

```{r log2cpm Conversion Full Matrix}
fC_Matrix_Full_cpm <- cpm(fC_Matrix_Full, log = TRUE)

boxplot(fC_Matrix_Full_cpm, xlab = "Conditions", ylab = expression("log"[2]* "counts per million"), ylim= c(-10, 20))

hist(fC_Matrix_Full_cpm, xlab = expression("log" [2]* "counts per million"))

#write this to a csv just in case to save it
#write.csv(fC_Matrix_Full_cpm, "C:/Users/emmap/RDirectory/Recovery_RNAseq/Recovery_RNAseq/featureCounts_Concat_Matrix_AllSamples_cpm_EMP_250210.csv")

```

```{r Filter Lowly Expressed Reads All Samples}

#first check the number of variables in the cpm file
dim(fC_Matrix_Full_cpm)
#[1] 28395    63

#now use rowMeans to filter out values with mean < 0 (this means rowMeans > 0 is what I'm left with) for each row/gene in the original file
rowMeans_All <- rowMeans(fC_Matrix_Full_cpm)
fC_Matrix_Full_cpm_filter <- fC_Matrix_Full_cpm[rowMeans_All > 0,]
dim(fC_Matrix_Full_cpm_filter)
#[1] 14225    63

#with this I've filtered out a significant number of rows when filtering after cpm conversion - does this make it more balanced?

hist(fC_Matrix_Full_cpm_filter, 
     main = "Recovery All Individuals log2cpm Filtered", 
        xlab = expression("log"[2]*"counts per million"))
boxplot(fC_Matrix_Full_cpm_filter, 
        main = "Recovery All Individuals log2cpm Filtered", 
        xlab = "Conditions", 
        ylab = expression("log"[2]*"counts per million"),
        ylim = c(-10,15))

#write this to a csv to save
#write.csv(fC_Matrix_Full_cpm_filter, "C:/Users/emmap/RDirectory/Recovery_RNAseq/Recovery_RNAseq/featureCounts_Concat_Matrix_AllSamples_cpm_filtered_EMP_250210.csv")

```


```{r QC Checks Unfiltered vs Filtered Reads}


####histogram of total counts, unfiltered####
hist(fC_Matrix_Full_cpm, main = "Recovery All Individuals log2cpm Unfiltered",
     xlab = expression("log" [2]* "counts per million"))

####histogram of total counts, filtered####
hist(fC_Matrix_Full_cpm_filter, 
     main = "Recovery All Individuals log2cpm Filtered rowMeans > 0", 
        xlab = expression("log"[2]*"counts per million"))

####boxplot log2cpm all samples####

boxplot(fC_Matrix_Full_cpm, xlab = "Conditions", ylab = expression("log"[2]* "counts per million"), ylim= c(-10, 20), main = "Boxplots of log2cpm per sample")

####boxplot log2cpm filtered all samples####

boxplot(fC_Matrix_Full_cpm_filter, xlab = "Conditions", ylab = expression("log"[2]* "counts per million"), ylim= c(-10, 20), main = "Boxplots of log2cpm Filtered rowMeans > 0 per sample")


```


Now that I've filtered the samples after log2cpm conversion, I can start to make heatmaps and PCA plots to look at my data

```{r PCA Plots All Data, include = FALSE}
# #mutate the file so that the samples are rows and columns are genes
# fC_Matrix_Full_cpm_filter_mutate <- data.frame(t(fC_Matrix_Full_cpm_filter))
# 
# #now let's separate out the factors we have in this experiment
# #Factor 1 - Individual
# Individual <- as.factor(c(rep("Ind1", 9), rep("Ind2", 9), rep("Ind3", 9), rep("Ind4", 9), rep("Ind5", 9), rep("Ind6", 9), rep("Ind6REP", 9)))
# 
# #Factor 2 - Treatment
# tx_factor <- c("DOX", "FLUO", "DMSO")
# Treatment <- as.factor(c(rep(tx_factor, 21)))
# #view(Treatment)
# 
# #Factor 3 - Timepoint
# time_factor <- c(rep("24hr", 3), rep("24hr Rec", 3), rep("6d Rec", 3))
# Time <- as.factor(c(rep(time_factor, 7)))
# #view(Time)
# 
# Full_filter_cpm_mutate_categories <- cbind(Individual, Treatment, Time, fC_Matrix_Full_cpm_filter_mutate)
# 
# pca_plot <- prcomp(fC_Matrix_Full_cpm_filter_mutate, scale. = TRUE)
# 
# # autoplot(pca_plot, data = Full_filter_cpm_mutate_categories, color = "Individual", shape = "Treatment", fill = "Time", size = 5, x=1, y=2)
# 
# 
# #now I want to try ggplot as the previous plot isn't showing my timepoints filled
# #can I pull PC1 and PC2 from my object (pca_plot[["rotation"]])?
# 
# #try and mutate it and see what happens with PC1 and PC2
# PCAs <- (pca_plot$rotation)
# #make this into a matrix
# Full_filter_cpm_mutate_categories_mat <- as.matrix(Full_filter_cpm_mutate_categories)
# 
# ggplot(pca_plot, Full_filter_cpm_mutate_categories_mat, aes(x=1,y=2, color=Time, shape=Treatment, fill=Individual))+
#   geom_point(size=3)+
#   scale_shape_manual(values = c(21, 22, 23) )+
#   scale_color_manual(values = c("white", "darkgray", "black") )+
#   scale_fill_manual(values = c("#003f5c", "#374c80", "#7A5195", "#BC5090", "#EF5675", "#FF764A", "#FFA600"))+
#   xlab("PC1")+
#   ylab("PC2")+
#   guides(fill=guide_legend(override.aes = list(shape=c(21,22, 23)), fill=c("#003f5c", "#374c80", "#7A5195", "#BC5090", "#EF5675", "#FF764A", "#FFA600"), color=c("white", "darkgray", "black")))
#   
#   
# 
# autoplot(pca_plot, data = Full_filter_cpm_mutate_categories, aes(x=1, y=2), color = Time, shape = Treatment, fill = Individual,
#          scale_shape_manual(values = c(21, 22, 23) ),
#          scale_color_manual(values = c("white", "darkgrey", "black") ),
#          scale_fill_manual(values = c("#003f5c", "#374c80", "#7A5195", "#BC5090", "#EF5675", "#FF764A", "#FFA600")),
#          guides(fill=guide_legend(override.aes = list(shape=c(21,22,23), fill=c("#003f5c", "#374c80", "#7A5195", "#BC5090", "#EF5675", "#FF764A", "#FFA600"), color=c("white", "darkgray", "black")))))
# 
# 
# autoplot(pca_plot, data = Full_filter_cpm_mutate_categories, color = Time, shape = Treatment, fill = Individual)+
#   scale_color_manual(values = c("white", "darkgray", "black"), aesthetics = "color")+
#   scale_fill_manual(values = c("#003f5c", "#374c80", "#7A5195", "#BC5090", "#EF5675", "#FF764A", "#FFA600"), aesthetics = "fill")+
#   scale_shape_manual(values = c(25,22,23))

```

```{r PCA Plots ggplot2 SIMPLIFIED, fig.width=6, fig.height=6, include = FALSE}

# PCA_data <- fC_Matrix_Full_cpm_filter %>% 
#   prcomp(.) %>% 
#   t()
# 
# PCA_data_test <- (prcomp(t(fC_Matrix_Full_cpm_filter), scale. = TRUE))
# 
# #make a function for pca - pulls stdv and makes a variance plot - look at the variance contributed by each PC
# pca_var_plot <- function(pca) {
#   pca.var <- pca$sdev ^ 2
#   pca.prop <- pca.var / sum(pca.var)
#   var.plot <- 
#     qplot(PC, prop, data = data.frame(PC = 1:length(pca.prop),
#                                       prop = pca.prop)) +
#     labs(title="Variance contributed by each PC",
#          x = "PC", y = "Proportion of Variance")
#   plot(var.plot)
# }
# 
# pca_var_plot(PCA_data_test)
# 
# 
# #make a pca plot function
# # pca_plot_fun <- function(df, 
# #                          col_var = NULL,
# #                          shape_var = NULL,
# #                          title = "") {
# #   ggplot(df) + geom_point(aes_string(
# #     x = "PC1",
# #     y = "PC2",
# #     color = col_var,
# #     shape = shape_var),
# #     size = 5) +
# #     labs(title = title, x = "PC 1", y = "PC 2") +
# #     scale_color_manual(values = c("#003f5c", "#374c80", "#7A5195", "#BC5090", "#EF5675", "#FF764A", "#FFA600")) +
# #                        scale_shape_manual(values = c(0, 1, 2, 5, 6, 15, 16, 17, 18))
# #   
# # }
# 
# colorsInd <- c("#003f5c", "#374c80", "#7A5195", "#BC5090", "#EF5675", "#FF764A", "#FFA600")
# 
# #now we can go into plotting!
# ####make an annotation matrix####
# annot <- data.frame("samples" = colnames(fC_Matrix_Full_cpm_filter)) %>% separate_wider_delim(., cols = samples, names = c("Tx", "Time", "Ind"), delim = "_", cols_remove = FALSE) %>% unite(., col = "Tx_Time", Tx, Time, sep = "_", remove = FALSE)
# 
# #combine the prcomp matrix and annotation
# annot_PCA_matrix <- PCA_data_test$x %>% cbind(., annot)
# 
# #now you can go ahead and make PCA plots with this matrix! woohoo!
# pca_plot_fun(annot_PCA_matrix, col_var = "Ind", shape_var = "Tx_Time")
# 
# annot_PCA_matrix %>% ggplot(., aes(x=PC1, y=PC2, size=6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#   # scale_color_manual(values = c("#003f5c", "#374c80", "#7A5195", "#BC5090", "#EF5675", "#FF764A", "#FFA600")) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
#   
# annot_PCA_matrix %>% ggplot(., aes(x=PC2, y=PC3, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# annot_PCA_matrix %>% ggplot(., aes(x=PC3, y=PC4, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# #Now that I've successfully generated ggplot PCA plots with Renee's code - now I can subset the data by time
# 
# time_24 <- annot_PCA_matrix %>% filter(Time=="24")
# time_24rec <- annot_PCA_matrix %>% filter(Time=="24rec")
# time_144rec <- annot_PCA_matrix %>% filter(Time=="144rec")
# 
# ####time 24hr####
# time_24 %>% ggplot(., aes(x=PC1, y=PC2, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# time_24 %>% ggplot(., aes(x=PC2, y=PC3, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# time_24 %>% ggplot(., aes(x=PC3, y=PC4, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# ####time 24rec####
# time_24rec %>% ggplot(., aes(x=PC1, y=PC2, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# time_24rec %>% ggplot(., aes(x=PC2, y=PC3, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# time_24rec %>% ggplot(., aes(x=PC3, y=PC4, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# ####time 144rec####
# time_144rec %>% ggplot(., aes(x=PC1, y=PC2, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# time_144rec %>% ggplot(., aes(x=PC2, y=PC3, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# time_144rec %>% ggplot(., aes(x=PC3, y=PC4, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# #####now that I've broken them up by time, try by treatment####
# 
# dox_rec <- annot_PCA_matrix %>% filter(Tx=="DOX")
# fluo_rec <- annot_PCA_matrix %>% filter(Tx=="FLUO")
# dmso_rec <- annot_PCA_matrix %>% filter(Tx=="DMSO")
# 
# ####DOX####
# dox_rec %>% ggplot(., aes(x=PC1, y=PC2, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# dox_rec %>% ggplot(., aes(x=PC2, y=PC3, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# dox_rec %>% ggplot(., aes(x=PC3, y=PC4, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# ####5FU####
# fluo_rec %>% ggplot(., aes(x=PC1, y=PC2, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# fluo_rec %>% ggplot(., aes(x=PC2, y=PC3, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# fluo_rec %>% ggplot(., aes(x=PC3, y=PC4, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# ####DMSO VEHICLE####
# dmso_rec %>% ggplot(., aes(x=PC1, y=PC2, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# dmso_rec %>% ggplot(., aes(x=PC2, y=PC3, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# dmso_rec %>% ggplot(., aes(x=PC3, y=PC4, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# #####Now I want to combine them with vehicle to see any effect
# dox_veh_rec <- annot_PCA_matrix %>% filter(Tx!="FLUO")
# fluo_veh_rec <- annot_PCA_matrix %>% filter(Tx!="DOX")
# 
# ####DOX + DMSO VEHICLE####
# dox_veh_rec %>% ggplot(., aes(x=PC1, y=PC2, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# dox_veh_rec %>% ggplot(., aes(x=PC2, y=PC3, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# dox_veh_rec %>% ggplot(., aes(x=PC3, y=PC4, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# 
# ####5FU + DMSO VEHICLE####
# fluo_veh_rec %>% ggplot(., aes(x=PC1, y=PC2, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# fluo_veh_rec %>% ggplot(., aes(x=PC2, y=PC3, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")
# 
# fluo_veh_rec %>% ggplot(., aes(x=PC3, y=PC4, size =6)) +
#   geom_point(aes(color = Tx_Time, shape = Ind)) +
#                        scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21)) +
#   scale_color_brewer(palette = "Paired")

```


After trying and failing to get all three factors on one PCA plot - I will make iterations of each of these with two factors each

```{r PCA Individual Treatment_Time, include = FALSE}

# #mutate the file so that the samples are rows and columns are genes
# fC_Matrix_Full_cpm_filter_mutate_tx_time <- data.frame(t(fC_Matrix_Full_cpm_filter))
# 
# #now let's separate out the factors we have in this experiment
# #Factor 1 - Individual
# Individual <- as.factor(c(rep("Ind1", 9), rep("Ind2", 9), rep("Ind3", 9), rep("Ind4", 9), rep("Ind5", 9), rep("Ind6", 9), rep("Ind6REP", 9)))
# 
# #Factor 2 - Treatment_Time
# tx_time_factor <- c("DOX_24", "FLUO_24", "DMSO_24", "DOX_24rec", "FLUO_24rec", "DMSO_24rec", "DOX_6drec", "FLUO_6drec", "DMSO_6drec")
# Treatment_Time <- as.factor(c(rep(tx_time_factor, 7)))
# #view(Treatment)
# 
# Full_filter_cpm_mutate_categories_txtime <- cbind(Individual, Treatment_Time, fC_Matrix_Full_cpm_filter_mutate_tx_time)
# 
# pca_plot_txtime <- prcomp(fC_Matrix_Full_cpm_filter_mutate_tx_time, scale. = TRUE)
# 
# autoplot(pca_plot_txtime, data = Full_filter_cpm_mutate_categories_txtime, color = "Treatment_Time", shape = "Individual", size = 5, x=1, y=2)
# 
# #when I try to use scale_shape_manual under ggplot - it gives the following error:
# ##Error in scale != 0 : 
#   ##comparison (!=) is possible only for atomic and list types
# #maybe try converting to an atomic vector or list?
# 
# shapes <- c(0, 1, 2, 5, 6, 15, 16, 17, 18)

#make a pca plot function
# pca_plot_fun_fill <- function(df,
#                          col_var = NULL,
#                          shape_var = NULL, 
#                          fill_var = NULL,
#                          title = "") {
#   ggplot(df) + geom_point(aes_string(
#     x = "PC1",
#     y = "PC2",
#     color = col_var,
#     shape = shape_var,
#     fill = fill_var,
#     size = 5)) +
#     labs(title = title) +
#     scale_color_manual(values = c("red", "blue", "darkgray")) +
#                        scale_shape_manual(values = c(0, 1, 2, 5, 6, 15, 16, 17, 18)) +
#     scale_fill_manual(values = c("#003f5c", "#374c80", "#7A5195", "#BC5090", "#EF5675", "#FF764A", "#FFA600"))
#   
# }


```


Now, I want to update these PCA plots to have treatment and time as the primary variables
Individual will be a fill? Or somehow get some numbers labelled on the points.
```{r PCA Plots Updated, fig.width=8, fig.height=8}
PCA_data <- fC_Matrix_Full_cpm_filter %>% 
  prcomp(.) %>% 
  t()

PCA_data_test <- (prcomp(t(fC_Matrix_Full_cpm_filter), scale. = TRUE))

####now make an annotation for my PCA####
annot <- data.frame("samples" = colnames(fC_Matrix_Full_cpm_filter)) %>% separate_wider_delim(., cols = samples, names = c("Tx", "Time", "Ind"), delim = "_", cols_remove = FALSE) %>% unite(., col = "Tx_Time", Tx, Time, sep = "_", remove = FALSE)

#combine the prcomp matrix and annotation
annot_PCA_matrix <- PCA_data_test$x %>% cbind(., annot)

#now I can make a graph where I have filled values for individual! I have seven colors for seven individuals
# I have three fill values for three timepoints

#using annotation matrix above as well as annotated PCA matrix (annot_PCA_matrix)

#pca_plot_fun_fill(annot_PCA_matrix, col_var = "Tx", shape_var = "Time", fill_var = "Ind")

####PC1/PC2####
# annot_PCA_matrix %>% ggplot(., aes(x=PC1, y=PC2)) +
#   geom_point(aes(color = Ind, shape = Time, fill = Tx, size = 10)) +
#                        scale_shape_manual(values = c(21, 22, 24)) +
#   scale_fill_manual(values =  tx_col)+
#   scale_color_manual(values = fill_col_ind_dark)+
#   guides(fill=guide_legend(override.aes=list(shape=25)))+
#   guides(color=guide_legend(override.aes=list(shape=25)))+
#   guides(fill=guide_legend(override.aes=list(shape=25,fill=tx_col,color=fill_col_ind_dark)))
# 
# #success! i finally got the legend to represent the colors and shapes
# #now let's make two more for PC2/PC3 and PC3/PC4
# 
# ####PC2/PC3####
# annot_PCA_matrix %>% ggplot(., aes(x=PC2, y=PC3)) +
#   geom_point(aes(color = Tx, shape = Time, fill = Ind, size = 10)) +
#                        scale_shape_manual(values = c(21, 22, 24)) +
#   scale_fill_manual(values =  fill_col_names)+
#   scale_color_manual(values = c("black", "red", "blue"))+
#   guides(fill=guide_legend(override.aes=list(shape=21)))+
#   guides(color=guide_legend(override.aes=list(shape=21)))+
#   guides(fill=guide_legend(override.aes=list(shape=21,fill=fill_col,color=fill_col)))
# 
# ####PC3/PC4####
# annot_PCA_matrix %>% ggplot(., aes(x=PC3, y=PC4)) +
#   geom_point(aes(color = Tx, shape = Time, fill = Ind, size = 10)) +
#                        scale_shape_manual(values = c(21, 22, 24)) +
#   scale_fill_manual(values =  fill_col_names)+
#   scale_color_manual(values = c("black", "red", "blue"))+
#   guides(fill=guide_legend(override.aes=list(shape=21)))+
#   guides(color=guide_legend(override.aes=list(shape=21)))+
#   guides(fill=guide_legend(override.aes=list(shape=21,fill=fill_col,color=fill_col)))


#extra info for colors in the graph (fill parameter)
fill_col_ind <- c("#66C2A5", "#FC8D62", "#1F78B4", "#E78AC3", "#A6D854", "#FFD92A", "#8B3E9B")

fill_col_ind_dark <- c("#003F5C", "#45AE91",  "#58508D", "#BC4099", "#8B3E9B", "#FF6361", "#FF2362")

fill_col_tx <- c("#63666D", "#DCACED", "#499FBD")

#Now I have to switch the fill and color parameters as it's doing the opposite of what I wanted: need individuals to be the outline color (color), and tx to be the inside color (fill)

####PC1/PC2####
annot_PCA_matrix %>% ggplot(., aes(x=PC1, y=PC2, size = 10)) +
  geom_point(aes(color = Ind, shape = Time, fill = Tx)) +
                       scale_shape_manual(values = c(21, 22, 24)) +
  scale_fill_manual(values =  fill_col_tx)+
  scale_color_manual(values = c(fill_col_ind_dark))+
  guides(fill=guide_legend(override.aes=list(shape=21)))+
  guides(color=guide_legend(override.aes=list(shape=21)))+
  guides(fill=guide_legend(override.aes=list(shape=21,fill=fill_col_tx,color=fill_col_tx)))

####PC2/PC3####
annot_PCA_matrix %>% ggplot(., aes(x=PC2, y=PC3)) +
  geom_point(aes(color = Ind, shape = Time, fill = Tx, size = 10)) +
                       scale_shape_manual(values = c(21, 22, 24)) +
  scale_fill_manual(values =  fill_col_tx)+
  scale_color_manual(values = c(fill_col_ind_dark))+
  guides(fill=guide_legend(override.aes=list(shape=21)))+
  guides(color=guide_legend(override.aes=list(shape=21)))+
  guides(fill=guide_legend(override.aes=list(shape=21,fill=fill_col_tx,color=fill_col_tx)))

####PC3/PC4####
annot_PCA_matrix %>% ggplot(., aes(x=PC3, y=PC4)) +
  geom_point(aes(color = Ind, shape = Time, fill = Tx, size = 10)) +
                       scale_shape_manual(values = c(21, 22, 24)) +
  scale_fill_manual(values =  fill_col_tx)+
  scale_color_manual(values = c(fill_col_ind_dark))+
  guides(fill=guide_legend(override.aes=list(shape=21)))+
  guides(color=guide_legend(override.aes=list(shape=21)))+
  guides(fill=guide_legend(override.aes=list(shape=21,fill=fill_col_tx,color=fill_col_tx)))



```


```{r Correlation Heatmaps, fig.width=12, fig.height=16}

#correlation heatmap for all samples

####PEARSON FILTERED####
fC_Matrix_Full_cpm_filter_pearsoncor <-
  cor(
    fC_Matrix_Full_cpm_filter,
    y = NULL,
    use = "everything",
    method = "pearson"
  )

####SPEARMAN FILTERED####
fC_Matrix_Full_cpm_filter_spearmancor <-
  cor(
    fC_Matrix_Full_cpm_filter,
    y = NULL,
    use = "everything",
    method = "spearman"
  )


#Now let's graph these correlations

pheatmap(fC_Matrix_Full_cpm_filter_pearsoncor, border_color = "black", legend = TRUE, angle_col = 90, display_numbers = FALSE, number_color = "black", fontsize = 12, fontsize_number = 9)

pheatmap(fC_Matrix_Full_cpm_filter_spearmancor, border_color = "black", legend = TRUE, angle_col = 90, display_numbers = FALSE, number_color = "black", fontsize = 12, fontsize_number = 9)



#now annotate these heatmaps
#Factor 1 - Individual
Individual <- as.factor(c(rep("Ind1", 9), rep("Ind2", 9), rep("Ind3", 9), rep("Ind4", 9), rep("Ind5", 9), rep("Ind6", 9), rep("Ind6REP", 9)))

#Factor 2 - Treatment
tx_factor <- c("DOX", "FLUO", "DMSO")
Tx <- as.factor(c(rep(tx_factor, 21)))
#view(Treatment)

#Factor 3 - Timepoint
time_factor <- c(rep("24", 3), rep("24rec", 3), rep("144rec", 3))
Time <- as.factor(c(rep(time_factor, 7)))

####annotation for colors####
annot_col_hm = list(Tx = c(DOX = "red", FLUO = "blue", DMSO = "black"),
                             Ind = c(Ind1 = "#66C2A5", Ind2 = "#FC8D62", Ind3 = "#1F78B4", Ind4 = "#E78AC3", Ind5 = "#A6D854", Ind6 = "#FFD92A", Ind6REP = "#8B3E9B"),
                             Time = c("24" = "#046A38", "24rec" = "#0050B5", "144rec" = "#B725AD"))

####annotation for values####
annot_list_hm <- data.frame(Individual = as.factor(c(rep("Ind1", 9), rep("Ind2", 9), rep("Ind3", 9), rep("Ind4", 9), rep("Ind5", 9), rep("Ind6", 9), rep("Ind6REP", 9))),
                                               Tx = as.factor(c(rep(tx_factor, 21))), 
                                               Time = as.factor(c(rep(time_factor, 7))))

  
##add in the annotations from above into the dataframe
row.names(annot_list_hm) <- colnames(fC_Matrix_Full_cpm_filter_pearsoncor)
row.names(annot_list_hm) <- colnames(fC_Matrix_Full_cpm_filter_spearmancor)

####ANNOTATED HEATMAPS####
pheatmap(fC_Matrix_Full_cpm_filter_pearsoncor, border_color = "black", legend = TRUE, angle_col = 90, display_numbers = FALSE, number_color = "black", fontsize = 10, fontsize_number = 5, annotation_col = annot_list_hm, annotation_colors = annot_col_hm)

pheatmap(fC_Matrix_Full_cpm_filter_spearmancor, border_color = "black", legend = TRUE, angle_col = 90, display_numbers = FALSE, number_color = "black", fontsize = 10, fontsize_number = 5, annotation_col = annot_list_hm, annotation_colors = annot_col_hm)


```

 
```{r All QC}

counts_DE_raw <- read_csv("C:/Users/emmap/RDirectory/Recovery_RNAseq/Recovery_RNAseq/featureCounts_Concat_Matrix_AllSamples_EMP_250220.csv")
#View(counts_DE)

counts_DE_norep <- as.data.frame(Counts_Full_df) %>% 
        #dplyr::select(-"...1") %>% 
        dplyr::select(-(contains("Ind6REP")))

#sometimes when loaded in this dataframe has the column ..1 - if needed uncomment that out

#now I've removed that individual, so I'll filter all counts by rowmeans
#first check the number of variables in the counts file
##I should have 54 samples if not including Ind6REP
dim(counts_DE_norep)
#[1] 78932    54 - original ensembl annotation
#[1] 28395    54 - new inbuilt annotation

####filter by rowMeans >1 to filter more####
rowMeans_DE <- rowMeans(counts_DE_norep)
counts_DE_filter1 <- counts_DE_norep[rowMeans_DE > 1,]
dim(counts_DE_filter1)
#[1] 65925    54 - original ensembl annotation
#[1] 20443    54 - new inbuilt annotation

# ####TOTAL NUMBER OF READS PER SAMPLE####
# tx_col <- list(Treatment = c("DMSO" = "#63666D","5FU" = "#DCACED","DOX" = "#499FBD"))
# counts_DE_raw %>% 
#   ggplot(., aes (x =samplenames, y=count, fill = drug, group_by=indv))+
#   geom_col()+
#  geom_hline(aes(yintercept=20000000))+
#  scale_fill_manual(values=drug_palc)+
#   ggtitle(expression("Total number of reads by sample"))+
#   xlab("")+
#   ylab(expression("RNA -sequencing reads"))+
#   theme_bw()+
#   theme(plot.title = element_text(size = rel(2), hjust = 0.5),
#         axis.title = element_text(size = 15, color = "black"),
#         axis.ticks = element_line(linewidth = 1.5),
#         axis.line = element_line(linewidth = 1.5),
#         axis.text.y = element_text(size =10, color = "black", angle = 0, hjust = 0.8, vjust = 0.5),
#         axis.text.x = element_text(size =10, color = "black", angle = 90, hjust = 1, vjust = 0.2),
#         #strip.text.x = element_text(size = 15, color = "black", face = "bold"),
#         strip.text.y = element_text(color = "white"))


```


```{r Differential Expression Analysis Test}

group <- c(rep(c(1, 2, 3, 4, 5, 6, 7, 8, 9), 6))
group <- factor(group, levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9"))


group_1 <- rep(c("DOX_24","FLUO_24",
                                "DMSO_24",
                                "DOX_24rec",
                                "FLUO_24rec",
                                "DMSO_24rec",
                                "DOX_144rec",
                                "FLUO_144rec",
                                "DMSO_144rec"), 6)

dge <- DGEList.data.frame(counts = counts_DE_filter1, group = group_1, genes = row.names(counts_DE_filter1))


#this is the inital file before norm factors are calculated
dge$samples

#calculate the normalization factors with method TMM
dge_calc <- calcNormFactors(dge, method = "TMM")

#final file after norm calculation
dge_calc$samples

#View(dge_calc)

#Pull out factors
snames <- data.frame("samples" = colnames(dge_calc)) %>% separate_wider_delim(., cols = samples, names = c("Treatment", "Time", "Individual"), delim = "_", cols_remove = FALSE)

#snames_list <- as.list(snames)

snames_time <- snames$Time
snames_tx <- snames$Treatment
snames_ind <- snames$Individual

#Create my model matrix
mm_r <- model.matrix(~0 + group_1)

p <- voom(dge_calc$counts, mm_r, plot = TRUE)

corfit <- duplicateCorrelation(p, mm_r, block = snames_ind)

v <- voom(dge_calc$counts, mm_r, block = snames_ind, correlation = corfit$consensus)

fit <- lmFit(v, mm_r, block = snames_ind, correlation = corfit$consensus)

#make sure to check which order the columns are in - otherwise they won't match right (it was moved into alphabetical and number order)
colnames(mm_r) <- c("DMSO_144rec","DMSO_24","DMSO_24rec","DOX_144rec","DOX_24","DOX_24rec","FLUO_144rec","FLUO_24","FLUO_24rec")

cm_r <- makeContrasts(
        V.D24 = DOX_24 - DMSO_24,
        V.F24 = FLUO_24 - DMSO_24,
        V.D24r = DOX_24rec - DMSO_24rec,
        V.F24r = FLUO_24rec - DMSO_24rec,
        V.D144r = DOX_144rec - DMSO_144rec,
        V.F144r = FLUO_144rec - DMSO_144rec,
        levels = mm_r
)

vfit_r <- lmFit(p, mm_r)
vfit_r <- contrasts.fit(vfit_r, contrasts = cm_r)

efit4 <- eBayes(vfit_r)

results = decideTests(efit4)
summary(results)
#these results are from rowMeans >0
#         V.D24 V.F24 V.D24r V.F24r V.D144r V.F144r
# Down    6441     0   2644      0     362       1
# NotSig 45643 65925  48194  65925   63810   65924
# Up     13841     0  15087      0    1753       0

#these results are from rowMeans > 5
#        V.D24 V.F24 V.D24r V.F24r V.D144r V.F144r
# Down    6174     0   2599      0     272       0
# NotSig 10944 23635  14353  23635   23269   23635
# Up      6517     0   6683      0      94       0


#new results rowMeans >0
#         V.D24 V.F24 V.D24r V.F24r V.D144r V.F144r
# Down    4567     0   2083      0     288       0
# NotSig 14521 26445  16339  26445   25296   26445
# Up      7357     0   8023      0     861       0

##still have no DE genes detected for 5FU, only DOX


####plot your voom####
voom_plot <- voom(dge_calc, mm_r, plot = TRUE)


```

```{r Do This Again But With Filtering, include=FALSE}

# counts_DE_raw
# 
# counts_DE
# 
# ####rowMeans >0####
# rowMeans_DE <- rowMeans(counts_DE)
# counts_DE_filter <- counts_DE[rowMeans_DE > 0,]
# dim(counts_DE_filter)
# 
# 
# ####rowMeans >1####
# rowMeans_DE <- rowMeans(counts_DE)
# counts_DE_filter <- counts_DE[rowMeans_DE > 0,]
# dim(counts_DE_filter)
# 
# ####rowMeans >2####
# rowMeans_DE <- rowMeans(counts_DE)
# counts_DE_filter <- counts_DE[rowMeans_DE > 0,]
# dim(counts_DE_filter)
# 
# ####rowMeans >3####
# rowMeans_DE <- rowMeans(counts_DE)
# counts_DE_filter <- counts_DE[rowMeans_DE > 0,]
# dim(counts_DE_filter)
# 
# ####rowMeans >4####
# rowMeans_DE <- rowMeans(counts_DE)
# counts_DE_filter_4 <- counts_DE[rowMeans_DE > 4,]
# dim(counts_DE_filter_4)
# 
# ####rowMeans >5####
# rowMeans_DE <- rowMeans(counts_DE)
# counts_DE_filter_5 <- counts_DE[rowMeans_DE > 5,]
# dim(counts_DE_filter_5)
# #[1] 23635    54
```


```{r Make a TopTable with Your New Data}

top.table_V.D24 <- topTable(fit = efit4, coef = "V.D24", number = nrow(dge_calc), adjust.method = "BH", p.value = 1, sort.by = "none")
head(top.table_V.D24)

top.table_V.F24 <- topTable(fit = efit4, coef = "V.F24", number = nrow(dge_calc), adjust.method = "BH", p.value = 1, sort.by = "none")
head(top.table_V.F24)

top.table_V.D24r <- topTable(fit = efit4, coef = "V.D24r", number = nrow(dge_calc), adjust.method = "BH", p.value = 1, sort.by = "none")
head(top.table_V.D24r)

top.table_V.F24r <- topTable(fit = efit4, coef = "V.F24r", number = nrow(dge_calc), adjust.method = "BH", p.value = 1, sort.by = "none")
head(top.table_V.F24r)

top.table_V.D144r <- topTable(fit = efit4, coef = "V.D144r", number = nrow(dge_calc), adjust.method = "BH", p.value = 1, sort.by = "none")
head(top.table_V.D144r)

top.table_V.F144r <- topTable(fit = efit4, coef = "V.F144r", number = nrow(dge_calc), adjust.method = "BH", p.value = 1, sort.by = "none")
head(top.table_V.F144r)

```


Volcano Plots
```{r Volcano Plots from Pairwise Gene Analysis, fig.height=8, fig.width=10}

generate_volcano_plot <- function(toptable, title) {
  
  # Add Significance Labels
  toptable$Significance <- "Not Significant"
  toptable$Significance[toptable$logFC > 0 & toptable$adj.P.Val < 0.05] <- "Upregulated"
  toptable$Significance[toptable$logFC < 0 & toptable$adj.P.Val < 0.05] <- "Downregulated"

  # Generate Volcano Plot
  ggplot(toptable, aes(x = logFC, y = -log10(P.Value), color = Significance)) +
    geom_point(alpha = 0.4, size = 2) + 
    scale_color_manual(values = c("Downregulated" = "red", "Upregulated" = "blue", "Not Significant" = "gray")) +
    xlim(-5, 5) +
    labs(title = title, x = "log2 Fold Change", y = "-log10 P-value") +
    theme(legend.position = "none", 
          plot.title = element_text(size = rel(1.5), hjust = 0.5),
          axis.title = element_text(size = rel(1.25))) +
    theme_bw()
}

#now that I've made a function, I can make volcano plots for each of my comparisons (6 total)

volcano_plots <- list(
  "V.D24" = generate_volcano_plot(top.table_V.D24, "Volcano Plot DOX 24hr (adj P-val<0.05)"),
  "V.F24" = generate_volcano_plot(top.table_V.F24, "Volcano Plot 5FU 24hr (adj P-val<0.05)"),
  "V.D24r" = generate_volcano_plot(top.table_V.D24r, "Volcano Plot DOX 24hr Recovery (adj P-val<0.05)"),
  "V.F24r" = generate_volcano_plot(top.table_V.F24r, "Volcano Plot 5FU 24hr Recovery (adj P-val<0.05)"),
  "V.D144r" = generate_volcano_plot(top.table_V.D144r, "Volcano Plot DOX 6d Recovery (adj P-val<0.05)"),
  "V.F144r" = generate_volcano_plot(top.table_V.F144r, "Volcano Plot 5FU 6d Recovery (adj P-val<0.05)")
)

# Display each volcano plot
for (plot_name in names(volcano_plots)) {
  print(volcano_plots[[plot_name]])
}



```

Now that I've gone through and figured out the basics of DE - let's remove unwanted variation using ruv
This uses my replicates to figure out covariates in the data and remove variation occurring due to batch effects or other effects
We're seeing a batch effect occurring here in PCA and cor. heatmaps

```{r Remove Unwanted Variation - RUVs}

# #counts need to be integer values and in a numeric matrix for ruv
# counts_DE_matrix <- as.matrix(counts_DE_filter1)
# dim(counts_DE_matrix)
# #[1] 20443    54 - new inbuilt
# #this does NOT contain the replicate samples, save for later
# 
# ##this file contains the replicates that I can pull from
# fC_Matrix_cpm_filter_ruv <- as.matrix (fC_Matrix_Full_cpm_filter)
# 
# #create a matrix specifying the replicates
# reps <- as.data.frame(fC_Matrix_Full_cpm_filter) %>%
#   dplyr::select(contains("Ind6"))
# dim(reps)
# #[1] 14225    18
# reps_mat <- as.matrix(reps)
# 
# #using the documentation do this:
# #controls: gene-by-sample numeric matrix containing counts
# controls <- rownames(fC_Matrix_Full_cpm_filter)
# 
# #I have replicates for Individual 6, which I can compare using this method
# #They are matched as following:
# ##col46:55, 47:56, 48:57, 49:58, 50:59, 51:60, 52:61, 53:62, 54:63
# ###this is the scIdx argument for reps, the cIdx argument is for genes
# #differences <- matrix(data = c(1, 10, 2, 11, 3, 12, 4, 13, 5, 14, 6, 15, 7, 16, 8, 17, 9, 18), byrow = TRUE, nrow = 9)
# differences_full <- matrix(data = c(46, 55, 47, 56, 48 , 57, 49, 58, 50 , 59, 51, 60, 52, 61, 53, 62, 54, 63), byrow = TRUE, nrow = 9)
# 
# 
# signature(x = "matrix", cIdx = "ANY", k = "numeric", scIdx = "matrix")
# 
# 
# seqRUVs <- RUVs(rep, controls, k=3, differences_full, isLog = TRUE)
# 
# pData(counts_DE)
# head(seqRUVs)
# 
# 
# ###now try putting this in your matrix?
# design <- model.matrix(~0 + group_1, seqRUVs)
# 
# 
# 
# 
# ####try it exactly like the documentation and filter afterwards?####
# genes <- rownames(fC_Matrix_Full)[grep("^"), rownames(fC_Matrix_Full)]
# spikes <- rownames()
# 
# ####leaving off here EMP 25/02/26####


```

