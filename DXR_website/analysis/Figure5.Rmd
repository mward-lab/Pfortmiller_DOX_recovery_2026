---
title: "Figure 5 Analysis"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: flatly
    highlight: textmate
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{css, echo=FALSE}
pre {
  max-height: 400px;
  overflow-y: auto;
}

pre[class] {
  max-height: 200px;
  
}
```


# Libraries

Load necessary libraries for analysis.

```{r Necessary Libraries, message=FALSE, warning=FALSE, echo=TRUE}
library(tidyverse)
library(readxl)
library(readr)
library(ComplexHeatmap)
library(reshape2)
library(circlize)
library(grid)
library(stringr)
library(org.Hs.eg.db)
library(AnnotationDbi)
```

Define my custom plot theme

```{r Custom plot theme, echo=TRUE, message=FALSE, warning=FALSE}

# Define the custom theme
# plot_theme_custom <- function() {
#   theme_minimal() +
#     theme(
#       #line for x and y axis
#       axis.line = element_line(linewidth = 1,
#                                color = "black"),
# 
#       #axis ticks only on x and y, length standard
#       axis.ticks.x = element_line(color = "black",
#                                 linewidth = 1),
#       axis.ticks.y = element_line(color = "black",
#                                 linewidth = 1),
#       axis.ticks.length = unit(0.05, "in"),
# 
#       #text and font
#       axis.text = element_text(color = "black",
#                                family = "Arial",
#                                size = 7),
#       axis.title = element_text(color = "black",
#                                 family = "Arial",
#                                 size = 9),
#       legend.text = element_text(color = "black",
#                                  family = "Arial",
#                                  size = 7),
#       legend.title = element_text(color = "black",
#                                   family = "Arial",
#                                   size = 9),
#       plot.title = element_text(color = "black",
#                                 family = "Arial",
#                                 size = 10),
# 
#       #blank background and border
#       panel.background = element_blank(),
#       panel.border = element_blank(),
# 
#       #gridlines for alignment
#       panel.grid.major = element_line(color = "grey80", linewidth = 0.5),  #grey major grid for align in illus
#       panel.grid.minor = element_line(color = "grey90", linewidth = 0.5) #grey minor grid for align in illus
#     )
# }

# saveRDS(plot_theme_custom, "data/plot_theme_custom.RDS")

theme_custom <- readRDS("data/plot_theme_custom.RDS")

```


Define a function to save plots as .pdf and .png

```{r pdf png saving function, echo=TRUE, message=FALSE, warning=FALSE}

save_plot <- function(plot, filename, 
                      folder = ".", 
                      width = 8, 
                      height = 6, 
                      units = "in", 
                      dpi = 300, 
                      add_date = TRUE) {
  if (missing(filename)) stop("Please provide a filename (without extension) for the plot.")

  date_str <- if (add_date) paste0("_", format(Sys.Date(), "%y%m%d")) else ""
  pdf_file <- file.path(folder, paste0(filename, date_str, ".pdf"))
  png_file <- file.path(folder, paste0(filename, date_str, ".png"))
  ggsave(filename = pdf_file, plot = plot, device = cairo_pdf, width = width, height = height, units = units, bg = "transparent")
  ggsave(filename = png_file, plot = plot, device = "png", width = width, height = height, units = units, dpi = dpi, bg = "transparent")
  message("Saved plot as Cairo PDF: ", pdf_file)
  message("Saved plot as PNG: ", png_file)
}

output_folder <- "C:/Users/emmap/OneDrive/Desktop/DXR Manuscript Materials/Fig pdfs"


#save plot function created
#to use: just define the plot name, filename_base, width, height
```

# Read in Gene Lists from Literature

I utilized gene sets from two additional studies - a p53 target gene set (Fischer, M., Census and evaluation of p53 target genes. Oncogene, 2017. 36(28): p. 3943-3956) and a DNA damage response (DDR) gene set (Liberzon, A., et al., The Molecular Signatures Database (MSigDB) hallmark gene set collection. Cell Syst, 2015. 1(6): p. 417-425). 

```{r Read in Gene Sets, message=FALSE, warning=FALSE}
#DDR gene set from Liberzon et al.

#read in my DDR gene set
DNA_damage <- readRDS("data/Fig5/DNA_damage_response_genes.RDS")

#pull out only the unique values that are not NA (there aren't any)
ddr_set <- unique(na.omit(DNA_damage))
#pull out the entrez ids
entrezids_DDR_R <- unname(DNA_damage)
#calculate the total length of my gene set for proportion analysis
total_ddr_genes <- length(ddr_set)
cat("Total DNA damage genes:", total_ddr_genes, "\n")
#should be 65 total genes


#p53 target genes from Fischer et al.
p53_target_genes <- readRDS("data/Fig5/p53_target_genes_list.RDS")

#pull out only the unique values that are not NA (there aren't any)
p53_set <- unique(na.omit(p53_target_genes))
#pull out the entrez ids
entrezids_p53 <- unname(p53_set)
#calculate the total length of my gene set for proportion analysis
total_p53_genes <- length(p53_set)
cat("Total p53 Target genes:", total_p53_genes, "\n")


```

# Figure 5A - Forest Plot of Odds Ratios

```{r Figure 5A, message=FALSE, warning=FALSE}

#define my gene clusters

final_genes_1_RUV <- readRDS("data/Fig3/final_genes_1_RUV.RDS")
final_genes_2_RUV <- readRDS("data/Fig3/final_genes_2_RUV.RDS")

motifs <- list(
  acute = final_genes_1_RUV,
  chronic = final_genes_2_RUV
)

#define the gene sets from above to test with a Fisher's exact test between clusters
gene_sets <- list(
  DDR = ddr_set,
  P53 = p53_set
)

#all tested genes as background
all_genes <- readRDS("data/DE/all_genes.RDS")

#compare between motif clusters for acute and chronic
compare_motifs <- function(acute, chronic, gene_set, gene_set_name) {
  in_chronic <- sum(chronic %in% gene_set)
  out_chronic <- length(chronic) - in_chronic
  in_acute <- sum(acute %in% gene_set)
  out_acute <- length(acute) - in_acute
  
  mat <- matrix(c(in_chronic, out_chronic, in_acute, out_acute), nrow = 2, byrow = TRUE)
  rownames(mat) <- c("Chronic", "Acute")
  colnames(mat) <- c("In_Set", "Not_In_Set")
  
  test <- fisher.test(mat)
  
  tibble(
    Gene_Set = gene_set_name,
    Motif_Comparison = "Chronic_vs_Acute",
    In_Set_Chronic = in_chronic,
    In_Set_Acute = in_acute,
    Odds_Ratio = as.numeric(test$estimate),
    CI_Low = test$conf.int[1],
    CI_High = test$conf.int[2],
    P_Value = test$p.value
  )
}

#apply for each gene set
comparison_results <- map_dfr(names(gene_sets), function(gs_name) {
  compare_motifs(final_genes_1_RUV, final_genes_2_RUV, gene_sets[[gs_name]], gs_name)
})

print(comparison_results)

#add sigificance and percent overlap
comparison_results <- comparison_results %>%
  mutate(
    Perc_Chronic = round((In_Set_Chronic / length(final_genes_2_RUV)) * 100, 2),
    Perc_Acute = round((In_Set_Acute / length(final_genes_1_RUV)) * 100, 2),
    Significance = case_when(
      P_Value < 0.001 ~ "***",
      P_Value < 0.01  ~ "**",
      P_Value < 0.05  ~ "*",
      TRUE ~ ""
    ),
    Odds_Ratio = round(Odds_Ratio, 3),
    CI_Low = round(CI_Low, 3),
    CI_High = round(CI_High, 3),
    P_Value = signif(P_Value, 3)
  )

#create a final summary table
summary_table <- comparison_results %>%
  dplyr::select(
    Gene_Set,
    In_Set_Chronic, Perc_Chronic,
    In_Set_Acute, Perc_Acute,
    Odds_Ratio, CI_Low, CI_High, P_Value, Significance
  )

cat("\n--- Chronic vs Acute Enrichment Summary ---\n")
print(summary_table)


#now create a forest plot
p_comparison <- ggplot(comparison_results,
                   aes(y = Gene_Set, x = Odds_Ratio,
                       xmin = CI_Low, xmax = CI_High)) +
  geom_point(size = 4) +
  geom_errorbarh(height = 0.1, size = 1, color = "black") + 
  geom_text(aes(label = Significance),
            position = position_nudge(y = 0.2),
            color = "black", fontface = "bold", size = 5) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") +
  scale_x_log10(limits = c(1, 30), 
                breaks = c(1, 10, 20)) +
  labs(
    x = "log odds ratio (95% confidence interval)",
    y = NULL,
    title = "Enrichment of DDR + p53 target genes Chronic vs Acute",
  ) +
  theme_custom()

print(p_comparison)

```



# Figure 5B - log2FC Heatmap DDR tx+144 DEGs

```{r Figure 5B, fig.height=4, fig.width=6, message=FALSE, warning=FALSE}

#load in DEGs for all timepoints 
DOX_24T_R <- read.csv("data/DE/Toptable_RUV_24T_final.csv") %>% 
  dplyr::select(-(X))
DOX_24R_R <- read.csv("data/DE/Toptable_RUV_24R_final.csv") %>% 
  dplyr::select(-(X))
DOX_144R_R <- read.csv("data/DE/Toptable_RUV_144R_final.csv") %>% 
  dplyr::select(-(X))

#extract Significant DEGs from these lists
DEGs_24T_R <- DOX_24T_R$Entrez_ID[DOX_24T_R$adj.P.Val < 0.05]
DEGs_24R_R <- DOX_24R_R$Entrez_ID[DOX_24R_R$adj.P.Val < 0.05]
DEGs_144R_R <- DOX_144R_R$Entrez_ID[DOX_144R_R$adj.P.Val < 0.05]


#DDR Entrez_ID and categories
entrez_category_DDR <- tribble(
  ~ENTREZID, ~Category,
  317, "Apoptosis", 355, "Apoptosis", 581, "Apoptosis", 637, "Apoptosis",
  836, "Apoptosis", 841, "Apoptosis", 842, "Apoptosis", 27113, "Apoptosis",
  5366, "Apoptosis", 54205, "Apoptosis", 55367, "Apoptosis", 8795, "Apoptosis",
  1026, "Cell Cycle / Checkpoint", 1027, "Cell Cycle / Checkpoint", 595, "Cell Cycle / Checkpoint",
  894, "Cell Cycle / Checkpoint", 896, "Cell Cycle / Checkpoint", 898, "Cell Cycle / Checkpoint",
  9133, "Cell Cycle / Checkpoint", 9134, "Cell Cycle / Checkpoint", 891, "Cell Cycle / Checkpoint",
  983, "Cell Cycle / Checkpoint", 1017, "Cell Cycle / Checkpoint", 1019, "Cell Cycle / Checkpoint",
  1020, "Cell Cycle / Checkpoint", 1021, "Cell Cycle / Checkpoint", 993, "Cell Cycle / Checkpoint",
  995, "Cell Cycle / Checkpoint", 1869, "Cell Cycle / Checkpoint", 4609, "Cell Cycle / Checkpoint",
  5925, "Cell Cycle / Checkpoint", 9874, "Cell Cycle / Checkpoint", 11011, "Cell Cycle / Checkpoint",
  1385, "Cell Cycle / Checkpoint",
  472, "Damage Sensors / Signal Transducers", 545, "Damage Sensors / Signal Transducers",
  5591, "Damage Sensors / Signal Transducers", 5810, "Damage Sensors / Signal Transducers",
  5883, "Damage Sensors / Signal Transducers", 5884, "Damage Sensors / Signal Transducers",
  6118, "Damage Sensors / Signal Transducers", 4361, "Damage Sensors / Signal Transducers",
  10111, "Damage Sensors / Signal Transducers", 4683, "Damage Sensors / Signal Transducers",
  84126, "Damage Sensors / Signal Transducers", 3014, "Damage Sensors / Signal Transducers",
  672, "DNA Repair", 2177, "DNA Repair", 5888, "DNA Repair", 5893, "DNA Repair",
  1647, "DNA Repair", 4616, "DNA Repair", 10912, "DNA Repair", 1111, "DNA Repair",
  11200, "DNA Repair", 1643, "DNA Repair", 8243, "DNA Repair", 5981, "DNA Repair",
  7157, "p53 Regulators / Targets", 4193, "p53 Regulators / Targets", 5371, "p53 Regulators / Targets",
  27244, "p53 Regulators / Targets", 50484, "p53 Regulators / Targets",
  207, "Miscellaneous / Broad", 25, "Miscellaneous / Broad"
)

entrez_ids_DDR_R <- entrez_category_DDR$ENTREZID


#function to extract relevant data
extract_data_DDR_RUV <- function(df, name) {
  df %>%
    filter(Entrez_ID %in% entrez_ids_DDR_R) %>%
    mutate(Gene = mapIds(org.Hs.eg.db, 
                         as.character(Entrez_ID),
                         column = "SYMBOL", 
                         keytype = "ENTREZID", 
                         multiVals = "first"),
           Condition = name,
           Signif = ifelse(adj.P.Val < 0.05, "*", ""))
}


#DEG list
deg_list_RUV <- list("t0" = DOX_24T_R, 
                 "t24" = DOX_24R_R, 
                 "t144" = DOX_144R_R
)

#combine all DEGs and annotate
all_data_DDR_RUV <- bind_rows(mapply(extract_data_DDR_RUV, deg_list_RUV, names(deg_list_RUV), SIMPLIFY = FALSE)) 

#now make a filtering step to only include DEGs at tx+144
sig_genes_t144 <- all_data_DDR_RUV %>% 
  dplyr::filter(Condition == "t144", adj.P.Val < 0.05) %>% 
  pull(Gene) %>% 
  unique()

filt_DDR_data_t144 <- all_data_DDR_RUV %>% 
  dplyr::filter(Gene %in% sig_genes_t144)

#create matrices
logFC_mat_DDR_RUV <- acast(filt_DDR_data_t144, Gene ~ Condition, value.var = "logFC")
signif_mat_DDR_RUV <- acast(filt_DDR_data_t144, Gene ~ Condition, value.var = "Signif")

#desired column order
desired_order <- c("t0",
                   "t24",
                   "t144")

logFC_mat_DDR_RUV <- logFC_mat_DDR_RUV[, desired_order]
signif_mat_DDR_RUV <- signif_mat_DDR_RUV[, desired_order]

#column annotation
meta_DDR_RUV <- str_split_fixed(colnames(logFC_mat_DDR_RUV), "_", 2)
timepoint_annot <- colnames(logFC_mat_DDR_RUV)
col_annot_DDR_RUV <- HeatmapAnnotation(
  Timepoint = timepoint_annot,
  col = list(
    Timepoint = c("t0" = "#005A4C", 
                  "t24" = "#328477", 
                  "t144" = "#8FB9B1")
  ),
  annotation_height = unit(c(1, 1, 1), "cm"),
  annotation_legend_param = list(
    Timepoint = list(
      at = c("t0", "t24", "t144")
    )
  )
)

#draw heatmap
ddr_hm_5b <- Heatmap(logFC_mat_DDR_RUV,
        name = "log2FC",
        top_annotation = col_annot_DDR_RUV,
        cluster_columns = FALSE,
        cluster_rows = FALSE,
        show_row_names = TRUE,
        row_names_gp = gpar(fontsize = 7),
        show_column_names = FALSE,
        column_names_gp = gpar(fontsize = 7), 
        rect_gp = gpar(col = "black", lwd = 0.5), 
        border = gpar(col = "black"),
        layer_fun = function(j, i, x, y, width, height, fill) {
          grid.text(signif_mat_DDR_RUV[cbind(i, j)], x, y, gp = gpar(fontsize = 12))
        },
        column_title = "DDR gene response (Liberzon et al.)",
        column_title_gp = gpar(fontsize = 9, fontface = "plain"),
        heatmap_legend_param = list(
          title_gp = gpar(fontsize = 8, fontface = "plain"),
          labels_gp = gpar(fontsize = 7, fontface = "plain")
  )
)

print(ddr_hm_5b)

#make a function to save complex heatmaps
save_complex_heatmap <- function(plot, filename, folder, width = 6, height = 8) {
  if (!dir.exists(folder)) dir.create(folder, recursive = TRUE)
    path <- file.path(folder, filename)
    pdf(path, width = width, height = height)
    draw(plot, heatmap_legend_side = "right")
    dev.off()
  message("Saved heatmap to: ", path)
}

#save to PDF in your output folder
# save_complex_heatmap(
#   plot = ddr_hm_5b,
#   filename = "Fig5B_logFCHM_RUV_DDR_EMP.pdf",
#   folder = output_folder,
#   width = 8,
#   height = 7
# )

```


# Figure 5C - p53 Target Genes logFC Heatmap

```{r Fig 5C, fig.height=8, fig.width=6, message=FALSE, warning=FALSE}

#use DEGs above

#p53 target Entrez_ID
entrez_ids_p53 <- c(1026,50484,4193,9766,9518,7832,1643,1647,1263,57103,51065,8795,51499,64393,581,
                5228,5429,8493,55959,7508,64782,282991,355,53836,4814,10769,9050,27244,9540,94241,
                26154,57763,900,26999,55332,26263,23479,23612,29950,9618,10346,8824,134147,55294,
                22824,4254,6560,467,27113,60492,8444,60401,1969,220965,2232,3976,55191,84284,93129,
                5564,7803,83667,7779,132671,7039,51768,137695,93134,7633,10973,340485,307,27350,
                23245,3732,29965,1363,1435,196513,8507,8061,2517,51278,53354,54858,23228,5366,5912,
                6236,51222,26152,59,1907,50650,91012,780,9249,11072,144455,64787,116151,27165,2876,
                57822,55733,57722,121457,375449,85377,4851,5875,127544,29901,84958,8797,8793,441631,
                220001,54541,5889,5054,25816,25987,5111,98,317,598,604,10904,1294,80315,53944,
                1606,2770,3628,3675,3985,4035,4163,84552,29085,55367,5371,5791,54884,5980,8794,
                1462,50808,220,583,694,1056,9076,10978,54677,1612,55040,114907,2274,127707,4000,
                8079,4646,4747,27445,5143,80055,79156,5360,5364,23654,5565,5613,5625,10076,56963,
                6004,390,255488,6326,6330,23513,7869,283130,204962,83959,6548,6774,9263,10228,
                22954,10475,85363,494514,10142,79714,1006,8446,9648,79828,5507,55240,63874,25841,
                9289,84883,154810,51321,421,8553,655,119032,84280,10950,824,839,57828,857,8812,
                8837,94027,113189,22837,132864,10898,3300,81704,1847,1849,1947,9538,24139,5168,
                147965,115548,9873,23768,2632,2817,3280,3265,23308,3490,51477,182,3856,8844,144811,
                9404,4043,9848,2872,23041,740,343263,4638,26509,4792,22861,57523,55214,80025,164091,
                57060,64065,51090,5453,8496,333926,55671,5900,55544,23179,8601,389,6223,55800,6385,
                4088,6643,122809,257397,285343,7011,54790,374618,55362,51754,7157,9537,22906,7205,
                80705,219699,55245,83719,7748,25946,118738)


#function to extract relevant data
extract_data_p53_RUV <- function(df, name) {
  df %>%
    filter(Entrez_ID %in% entrez_ids_p53) %>%
    mutate(Gene = mapIds(org.Hs.eg.db, 
                         as.character(Entrez_ID),
                         column = "SYMBOL", 
                         keytype = "ENTREZID", 
                         multiVals = "first"),
           Condition = name,
           Signif = ifelse(adj.P.Val < 0.05, "*", ""))
}

#DEG list
deg_list_RUV <- list("t0" = DOX_24T_R, 
                 "t24" = DOX_24R_R, 
                 "t144" = DOX_144R_R
)

#combine all DEGs and annotate
all_data_p53_RUV <- bind_rows(mapply(extract_data_p53_RUV, deg_list_RUV, 
                                     names(deg_list_RUV), SIMPLIFY = FALSE)) 

#now make a filtering step to only include DEGs at tx+144
sig_genes_t144 <- all_data_p53_RUV %>% 
  dplyr::filter(Condition == "t144", adj.P.Val < 0.05) %>% 
  pull(Gene) %>% 
  unique()

filt_p53_data_t144 <- all_data_p53_RUV %>% 
  dplyr::filter(Gene %in% sig_genes_t144)

#create matrices
logFC_mat53_RUV <- acast(filt_p53_data_t144, Gene ~ Condition, value.var = "logFC")
signif_mat53_RUV <- acast(filt_p53_data_t144, Gene ~ Condition, value.var = "Signif")

#desired column order
desired_order <- c("t0",
                   "t24",
                   "t144")

logFC_mat_p53_RUV <- logFC_mat53_RUV[, desired_order]
signif_mat_p53_RUV <- signif_mat53_RUV[, desired_order]

#column annotation
timepoint_annot <- colnames(logFC_mat_p53_RUV)

col_annot_p53_RUV <- HeatmapAnnotation(
  Timepoint = timepoint_annot,
  col = list(
    Timepoint = c("t0" = "#005A4C", 
             "t24" = "#328477", 
             "t144" = "#8FB9B1")
  ),
  annotation_height = unit(c(1, 1, 1), "cm"),
  annotation_legend_param = list(
    Timepoint = list(
      at = c("t0", "t24", "t144")
    )
  )
)

#draw heatmap
p53_hm_5c <- Heatmap(
  logFC_mat_p53_RUV,
  name = "log2FC",
  top_annotation = col_annot_p53_RUV,
  cluster_columns = FALSE,
  cluster_rows = TRUE,
  show_row_names = TRUE,
  row_names_gp = gpar(fontsize = 7),
  show_column_names = FALSE,
  column_names_gp = gpar(fontsize = 7), 
  rect_gp = gpar(col = "black", lwd = 0.5),   
  border = "black",
  layer_fun = function(j, i, x, y, width, height, fill) {
    grid.text(signif_mat_p53_RUV[cbind(i, j)], x, y, gp = gpar(fontsize = 12))
  },
  column_title = "p53 gene response (Fischer et al.)",
  column_title_gp = gpar(fontsize = 9, fontface = "plain"),
  heatmap_legend_param = list(
          title_gp = gpar(fontsize = 8, fontface = "plain"),
          labels_gp = gpar(fontsize = 7)
  )
)

print(p53_hm_5c)

```


# Supplementary Figure 8A - DDR target gene enrichment in DEGs vs nonDEGs

```{r Supp8A, message=FALSE, warning=FALSE}

#DEGs list
timepoint_DEGs_ddr <- list(
  "t0"   = DEGs_24T_R,
  "t24"   = DEGs_24R_R,
  "t144"  = DEGs_144R_R
)

#calculate proportions, odds ratios, and Fisher's test results per timepoint
proportion_data_ddr <- purrr::map_dfr(names(timepoint_DEGs_ddr), function(tp_ddr) {
  degs_ddr <- unique(timepoint_DEGs_ddr[[tp_ddr]])
  nondegs_ddr <- setdiff(all_genes, degs_ddr)
  
  in_deg_ddr <- sum(degs_ddr %in% ddr_set)
  in_deg_nonddr <- length(degs_ddr) - in_deg_ddr
  
  in_nondeg_ddr <- sum(nondegs_ddr %in% ddr_set)
  in_nondeg_nonddr <- length(nondegs_ddr) - in_nondeg_ddr
  
  contingency_degs_ddr <- matrix(c(in_deg_ddr, in_deg_nonddr,
                                   in_nondeg_ddr, in_nondeg_nonddr),
                                 nrow = 2, byrow = TRUE)
  
  fisher_res_ddr <- fisher.test(contingency_degs_ddr)
  
  p_val_ddr <- fisher_res_ddr$p.value
  odds_ratio_ddr <- unname(fisher_res_ddr$estimate)
  ci_low_ddr <- fisher_res_ddr$conf.int[1]
  ci_high_ddr <- fisher_res_ddr$conf.int[2]
  
  tibble(
    Timepoint = tp_ddr,
    Odds_Ratio = odds_ratio_ddr,
    CI_low = ci_low_ddr,
    CI_high = ci_high_ddr,
    P_Value = p_val_ddr,
    Significant = p_val_ddr < 0.05
  )
})

# Format Timepoint factor and add significance label/color
proportion_data_ddr <- proportion_data_ddr %>%
  mutate(
    Timepoint = factor(Timepoint, levels = c("t0", "t24", "t144")),
    Sig_Label = ifelse(Significant, "Significant", "Not Significant")
  )

#plot horizontal forest plot
supp8_forest_ddr_A <- ggplot(proportion_data_ddr, aes(y = Timepoint, x = Odds_Ratio, color = Sig_Label)) +
  geom_point(size = 5) +
  geom_errorbarh(aes(xmin = CI_low, xmax = CI_high), height = 0.3) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("Significant" = "black", "Not Significant" = "pink")) +
  scale_x_log10() +
  labs(
    title = "Odds Ratios of DDR Gene Enrichment by Timepoint",
    y = "Timepoint",
    x = "Odds Ratio (log scale)",
    color = "Significance"
  ) +
  scale_y_discrete(limits = rev(levels(proportion_data_ddr$Timepoint)))+
  theme_custom()

print(supp8_forest_ddr_A)

# save_plot( 
#   plot = supp8_forest_ddr_A,
#   filename = "Supp8_ForestDDR_EMP",
#   folder = output_folder,
#   height = 4,
#   width = 6)



```


# Supplementary Figure 8B - p53 target gene enrichment in DEGs vs nonDEGs

```{r Supp 8B, message=FALSE, warning=FALSE}

timepoint_DEGs_p53 <- list(
  "t0"   = DEGs_24T_R,
  "t24"   = DEGs_24R_R,
  "t144"  = DEGs_144R_R
)

proportion_data_p53 <- purrr::map_dfr(names(timepoint_DEGs_p53), function(tp_p53) {
  degs_p53 <- unique(timepoint_DEGs_p53[[tp_p53]])
  nondegs_p53 <- setdiff(all_genes, degs_p53)
  
  in_deg_p53 <- sum(degs_p53 %in% p53_set)
  in_deg_nonp53 <- length(degs_p53) - in_deg_p53
  
  in_nondeg_p53 <- sum(nondegs_p53 %in% p53_set)
  in_nondeg_nonp53 <- length(nondegs_p53) - in_nondeg_p53
  
  contingency_degs_p53 <- matrix(c(in_deg_p53, in_deg_nonp53,
                                   in_nondeg_p53, in_nondeg_nonp53),
                                 nrow = 2, byrow = TRUE)
  
  fisher_res_p53 <- fisher.test(contingency_degs_p53)
  
  p_val_p53 <- fisher_res_p53$p.value
  odds_ratio_p53 <- unname(fisher_res_p53$estimate)
  ci_low_p53 <- fisher_res_p53$conf.int[1]
  ci_high_p53 <- fisher_res_p53$conf.int[2]
  
  tibble(
    Timepoint = tp_p53,
    Odds_Ratio = odds_ratio_p53,
    CI_low = ci_low_p53,
    CI_high = ci_high_p53,
    P_Value = p_val_p53,
    Significant = p_val_p53 < 0.01
  )
})

# Format Timepoint factor and add significance label/color
proportion_data_p53 <- proportion_data_p53 %>%
  mutate(
    Timepoint = factor(Timepoint, levels = c("t0", "t24", "t144")),
    Sig_Label = ifelse(Significant, "Significant", "Not Significant")
  )

#plot horizontal forest plot with color by significance
supp8_forest_p53_B <- ggplot(proportion_data_p53, aes(y = Timepoint, x = Odds_Ratio, color = Sig_Label)) +
  geom_point(size = 5) +
  geom_errorbarh(aes(xmin = CI_low, xmax = CI_high), height = 0.3) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("Significant" = "black", "Not Significant" = "pink")) +
  scale_x_log10() +
  labs(
    title = "Odds Ratios of p53 Gene Enrichment by Timepoint",
    y = "Timepoint",
    x = "Odds Ratio (log scale)",
    color = "Significance"
  ) +
  scale_y_discrete(limits = rev(levels(proportion_data_p53$Timepoint)))+
  theme_custom()


print(supp8_forest_p53_B)

# save_plot(
#   plot = supp8_forest_p53_B,
#   filename = "Supp8B_Forestp53_EMP",
#   folder = output_folder,
#   height = 4,
#   width = 6)



```

